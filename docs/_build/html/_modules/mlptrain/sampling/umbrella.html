

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mlptrain.sampling.umbrella &mdash; mlp-train  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            mlp-train
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mlp-train</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mlptrain.sampling.umbrella</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mlptrain.sampling.umbrella</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">simpson</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io.trajectory</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trajectory</span> <span class="k">as</span> <span class="n">ASETrajectory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">write</span> <span class="k">as</span> <span class="n">ase_write</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.bias</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">DummyCoordinate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.configurations</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigurationSet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.md</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_mlp_md</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">move_files</span><span class="p">,</span> <span class="n">convert_ase_energy</span><span class="p">,</span> <span class="n">convert_exponents</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_Window</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contains the attributes belonging to an US window used for WHAM or UI&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_zetas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Bias&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Umbrella Window</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            obs_zetas: Values of the sampled (observed) reaction coordinate</span>
<span class="sd">                       ζ_i for this window (i)</span>

<span class="sd">            bias: Bias function, containing a reference value of ζ in this</span>
<span class="sd">                  window and its associated spring constant</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span> <span class="o">=</span> <span class="n">bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obs_zetas</span> <span class="o">=</span> <span class="n">obs_zetas</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_pdf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_FittedGaussian</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_plotted</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_FittedGaussian</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_energies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_energy</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bin the observed reaction coordinates in this window into an a set</span>
<span class="sd">        of bins, defined by the array of bin centres&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot bin with undefined bin edges&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obs_zetas</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_energies</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="o">.</span><span class="n">kappa</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bin_centres</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="o">.</span><span class="n">ref</span>
        <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bin_centres</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Array of zeta values at bin centres&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_edges</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gaussian_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_FittedGaussian&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fitted gaussian as a probability density function&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_gaussian</span><span class="p">(</span><span class="n">normalised</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_pdf</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gaussian_plotted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_FittedGaussian&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gaussian which was plotted during umbrella sampling simulation&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_plotted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;No plotted gaussian is stored in the window, &#39;</span>
                <span class="s1">&#39;make sure to run umbrella sampling first&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_plotted</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of samples in this window&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot determine the number of samples - &#39;</span>
                <span class="s1">&#39;window has not been binned&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dAu_dq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zetas</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;PMF from a single window&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_pdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot estimate PMF if the window does not &#39;</span>
                <span class="s1">&#39;contain a fitted probability density function&#39;</span>
            <span class="p">)</span>

        <span class="n">mean_zeta_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_pdf</span><span class="o">.</span><span class="n">mean</span>
        <span class="n">std_zeta_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_pdf</span><span class="o">.</span><span class="n">std</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="o">.</span><span class="n">kappa</span>
        <span class="n">zeta_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta_ref</span>

        <span class="c1"># Equation 8.8.21 from Tuckerman, p. 344</span>
        <span class="n">_dAu_dq</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">zetas</span> <span class="o">-</span> <span class="n">mean_zeta_b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">std_zeta_b</span><span class="o">**</span><span class="mi">2</span>
        <span class="p">)</span> <span class="o">-</span> <span class="n">kappa</span> <span class="o">*</span> <span class="p">(</span><span class="n">zetas</span> <span class="o">-</span> <span class="n">zeta_ref</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_dAu_dq</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zeta_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ζ_ref for this window</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Returns:</span>
<span class="sd">            (float):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="o">.</span><span class="n">ref</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_Window&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a window from a saved file</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>
<span class="sd">            filename:</span>

<span class="sd">        Returns:</span>
<span class="sd">            (mlptrain.sampling.umbrella._Window):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">header_line</span> <span class="o">=</span> <span class="n">file_lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Pop the first line</span>

        <span class="n">ref_zeta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header_line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Å</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header_line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># eV / Å^2</span>

        <span class="n">obs_zeta</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_lines</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">]</span>

        <span class="n">window</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">obs_zetas</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obs_zeta</span><span class="p">),</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">Bias</span><span class="p">(</span>
                <span class="n">zeta_func</span><span class="o">=</span><span class="n">DummyCoordinate</span><span class="p">(),</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">ref_zeta</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">window</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save this window to a file</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>
<span class="sd">            filename:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="o">.</span><span class="n">kappa</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">zeta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_zetas</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">zeta</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fit_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalised</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit a gaussian to a histogram of data&quot;&quot;&quot;</span>

        <span class="n">gaussian</span> <span class="o">=</span> <span class="n">_FittedGaussian</span><span class="p">()</span>

        <span class="n">a_0</span><span class="p">,</span> <span class="n">mu_0</span><span class="p">,</span> <span class="n">sigma_0</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obs_zetas</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_obs_zetas</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gaussian</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
                <span class="n">gaussian</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bin_centres</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">,</span>
                <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>  <span class="c1"># init guess</span>
                <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Could not fit gaussian to a histogram, using &#39;</span>
                <span class="s1">&#39;parameters obtained without fitting instead&#39;</span>
            <span class="p">)</span>

            <span class="n">gaussian</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">a_0</span><span class="p">,</span> <span class="n">mu_0</span><span class="p">,</span> <span class="n">sigma_0</span>

        <span class="k">if</span> <span class="n">normalised</span><span class="p">:</span>
            <span class="n">gaussian</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">gaussian</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_pdf</span> <span class="o">=</span> <span class="n">gaussian</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">bin_centres</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit a Gaussian to a histogram of data and plot the result&quot;&quot;&quot;</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">gaussian</span> <span class="o">=</span> <span class="n">_FittedGaussian</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gaussian</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
                <span class="n">gaussian</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">bin_centres</span><span class="p">,</span>
                <span class="n">hist</span><span class="p">,</span>
                <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bin_centres</span> <span class="o">-</span> <span class="n">gaussian</span><span class="o">.</span><span class="n">mean</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Gaussian mean was not within the 1 Å of &#39;</span> <span class="s1">&#39;the ζ range&#39;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to fit a gaussian to this data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Plot the fitted line in the same color as the histogram</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>
        <span class="n">zetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">bin_centres</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">bin_centres</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zetas</span><span class="p">,</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">zetas</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gaussian_plotted</span> <span class="o">=</span> <span class="n">gaussian</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">min_zeta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_zeta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">plot_gaussian</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot this window along with a fitted Gaussian function if possible</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>
<span class="sd">            min_zeta:</span>

<span class="sd">            max_zeta:</span>

<span class="sd">            plot_gaussian:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obs_zetas</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="n">min_zeta</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_zeta</span><span class="p">),</span>
                <span class="n">max_zeta</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_zeta</span><span class="p">),</span>
                <span class="n">num</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">bin_centres</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_centres</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_gaussian</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_gaussian</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">bin_centres</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Reaction coordinate / Å&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;fitted_data.pdf&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="UmbrellaSampling">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UmbrellaSampling</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Umbrella sampling class for generating pulling simulation, running</span>
<span class="sd">    umbrella sampling windows and running WHAM or umbrella integration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">zeta_func</span><span class="p">:</span> <span class="s1">&#39;mlptrain.sampling.reaction_coord.ReactionCoordinate&#39;</span><span class="p">,</span>
        <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Umbrella sampling to predict free energy using an mlp under a harmonic</span>
<span class="sd">        bias:</span>

<span class="sd">            ω = κ/2 (ζ(r) - ζ_ref)^2</span>

<span class="sd">        where ω is the bias in a particular window, ζ a function that takes in</span>
<span class="sd">        nuclear positions (r) and returns a scalar and ζ_ref the reference</span>
<span class="sd">        value of the reaction coordinate in that particular window.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            zeta_func: Reaction coordinate, as the function of atomic positions</span>

<span class="sd">            kappa: Value of the spring constant, κ, used in umbrella sampling</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">kappa</span>  <span class="c1"># eV Å^-2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeta_func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">zeta_func</span>  <span class="c1"># ζ(r)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>  <span class="c1"># K</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_Window</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_best_init_frame</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">traj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the frames whose bias value is the lowest, i.e. has the</span>
<span class="sd">        closest reaction coordinate to the desired&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot determine the best frame from a &#39;</span>
                <span class="s1">&#39;trajectory with length zero&#39;</span>
            <span class="p">)</span>

        <span class="n">min_e_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">bias</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">ase_atoms</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">traj</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">traj</span><span class="p">[</span><span class="n">min_e_idx</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reference_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">init_ref</span><span class="p">,</span> <span class="n">final_ref</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the values of the reference for each window, if the</span>
<span class="sd">        initial and final reference values of the reaction coordinate are None</span>
<span class="sd">        then use the values in the start or end of the trajectory&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">init_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">init_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta_func</span><span class="p">(</span><span class="n">traj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">final_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta_func</span><span class="p">(</span><span class="n">traj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">init_ref</span><span class="p">,</span> <span class="n">final_ref</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_no_ok_frame_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does there exist a good reference structure in a trajectory?</span>
<span class="sd">        defined by the minimum absolute difference in the reaction coordinate</span>
<span class="sd">        (ζ) observed in the trajectory and the target value</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>
<span class="sd">            traj: A trajectory containing structures</span>
<span class="sd">            ref: ζ_ref</span>

<span class="sd">        Returns:</span>
<span class="sd">            (bool):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zeta_func</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span> <span class="o">-</span> <span class="n">ref</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

<div class="viewcode-block" id="UmbrellaSampling.run_umbrella_sampling">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.run_umbrella_sampling">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_umbrella_sampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">traj</span><span class="p">:</span> <span class="s1">&#39;mlptrain.ConfigurationSet&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">init_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">final_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_windows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">save_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">all_to_xyz</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run umbrella sampling across n_windows, fitting Gaussians to the</span>
<span class="sd">        sampled values of the reaction coordinate.</span>

<span class="sd">        *NOTE* will leave a dangling plt.figure open</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>
<span class="sd">            traj: Trajectory from which to initialise the umbrella over, e.g.</span>
<span class="sd">                  a &#39;pulling&#39; trajectory that has sufficient sampling of a</span>
<span class="sd">                  range f reaction coordinates</span>

<span class="sd">            mlp: Machine learnt potential</span>

<span class="sd">            temp: Temperature in K to initialise velocities and to run NVT MD.</span>
<span class="sd">                  Must be positive</span>

<span class="sd">            interval: (int) Interval between saving the geometry</span>

<span class="sd">            dt: (float) Time-step in fs</span>

<span class="sd">            init_ref: (float | None) Value of reaction coordinate in Å for</span>
<span class="sd">                                     first window</span>

<span class="sd">            final_ref: (float | None) Value of reaction coordinate in Å for</span>
<span class="sd">                                      first window</span>

<span class="sd">            n_windows: (int) Number of windows to run in the umbrella sampling</span>

<span class="sd">            save_sep: (bool) If True saves trajectories of each window</span>
<span class="sd">                             separately as .xyz files</span>

<span class="sd">            all_to_xyz: (bool) If True all .traj trajectory files are saved as</span>
<span class="sd">                               .xyz files (when using save_fs, save_ps, save_ns)</span>

<span class="sd">        -------------------</span>
<span class="sd">        Keyword Arguments:</span>

<span class="sd">            {fs, ps, ns}: Simulation time in some units</span>

<span class="sd">            {save_fs, save_ps, save_ns}: Trajectory saving interval</span>
<span class="sd">                                         in some units</span>

<span class="sd">            constraints: (List) List of ASE constraints to use in the dynamics</span>
<span class="sd">                                e.g. [ase.constraints.Hookean(a1, a2, k, rt)]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_umbrella</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Temperature must be positive and non-zero for &#39;</span>
                <span class="s1">&#39;umbrella sampling&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="n">zeta_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_values</span><span class="p">(</span>
            <span class="n">traj</span><span class="p">,</span> <span class="n">n_windows</span><span class="p">,</span> <span class="n">init_ref</span><span class="p">,</span> <span class="n">final_ref</span>
        <span class="p">)</span>

        <span class="c1"># window_process.get() --&gt; window_traj</span>
        <span class="n">window_processes</span><span class="p">,</span> <span class="n">window_trajs</span><span class="p">,</span> <span class="n">biases</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">n_processes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_windows</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Running Umbrella Sampling with </span><span class="si">{</span><span class="n">n_windows</span><span class="si">}</span><span class="s1"> window(s), &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_processes</span><span class="si">}</span><span class="s1"> window(s) are run in parallel&#39;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zeta_refs</span><span class="p">):</span>
                <span class="c1"># Without copy kwargs is overwritten at every iteration</span>
                <span class="n">kwargs_single</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">kwargs_single</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">kwargs_single</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>

                <span class="n">bias</span> <span class="o">=</span> <span class="n">Bias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zeta_func</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_ok_frame_in</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
                    <span class="c1"># Takes the trajectory of the previous window, .get() blocks</span>
                    <span class="c1"># the main process until the previous window finishes</span>
                    <span class="n">_traj</span> <span class="o">=</span> <span class="n">window_processes</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_traj</span> <span class="o">=</span> <span class="n">traj</span>

                <span class="n">init_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_init_frame</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">_traj</span><span class="p">)</span>

                <span class="n">window_process</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_individual_window</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">init_frame</span><span class="p">,</span> <span class="n">mlp</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bias</span><span class="p">),</span>
                    <span class="n">kwds</span><span class="o">=</span><span class="n">kwargs_single</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">window_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window_process</span><span class="p">)</span>
                <span class="n">biases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">window_process</span><span class="p">,</span> <span class="n">bias</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">window_processes</span><span class="p">,</span> <span class="n">biases</span><span class="p">):</span>
                <span class="n">window_traj</span> <span class="o">=</span> <span class="n">window_process</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">_Window</span><span class="p">(</span>
                    <span class="n">obs_zetas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zeta_func</span><span class="p">(</span><span class="n">window_traj</span><span class="p">),</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span>
                <span class="p">)</span>
                <span class="n">window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">min_zeta</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">zeta_refs</span><span class="p">),</span>
                    <span class="n">max_zeta</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">zeta_refs</span><span class="p">),</span>
                    <span class="n">plot_gaussian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
                <span class="n">window_trajs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window_traj</span><span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">finish_umbrella</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Umbrella sampling done in &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">finish_umbrella</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_umbrella</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> m&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Move .traj files into &#39;trajectories&#39; folder and compute .xyz files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_move_and_save_files</span><span class="p">(</span>
            <span class="n">window_trajs</span><span class="o">=</span><span class="n">window_trajs</span><span class="p">,</span> <span class="n">save_sep</span><span class="o">=</span><span class="n">save_sep</span><span class="p">,</span> <span class="n">all_to_xyz</span><span class="o">=</span><span class="n">all_to_xyz</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_run_individual_window</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frame</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Bias&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run an individual umbrella sampling window&quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Running US window </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> with &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;ζ_ref=</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> Å &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;and κ = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> eV / Å^2&#39;</span>
        <span class="p">)</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">traj</span> <span class="o">=</span> <span class="n">run_mlp_md</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span>
            <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">kept_substrings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.traj&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">traj</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_move_and_save_files</span><span class="p">(</span>
        <span class="n">window_trajs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;mlptrain.Trajectory&#39;</span><span class="p">],</span>
        <span class="n">save_sep</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">all_to_xyz</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save window trajectories, move them into trajectories folder and</span>
<span class="sd">        compute .xyz files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;trajectory_\d+\.traj&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;trajectory_\d+_\w+\.traj&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;trajectories&#39;</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;trajectories&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_sep</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">traj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">window_trajs</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">traj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;window_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.xyz&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_traj</span> <span class="o">=</span> <span class="n">ConfigurationSet</span><span class="p">(</span><span class="n">allow_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">window_traj</span> <span class="ow">in</span> <span class="n">window_trajs</span><span class="p">:</span>
                <span class="n">combined_traj</span> <span class="o">+=</span> <span class="n">window_traj</span>

            <span class="n">combined_traj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;combined_trajectory.xyz&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_to_xyz</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;trajectory_\d+_\w+\.traj&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">sim_time</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">ase_traj</span> <span class="o">=</span> <span class="n">ASETrajectory</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">ase_write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;window_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sim_time</span><span class="si">}</span><span class="s1">.xyz&#39;</span><span class="p">,</span> <span class="n">ase_traj</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="UmbrellaSampling.free_energies">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.free_energies">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">free_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob_dist</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Free energies at each point along the profile, eqn. 8.6.5 in Tuckerman</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray): A(ζ)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_dist</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zeta_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Array of ζ_ref for each window</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray(float) | None):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">w_k</span><span class="o">.</span><span class="n">zeta_ref</span> <span class="k">for</span> <span class="n">w_k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">beta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        β = 1 / (k_B T)</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Returns:</span>
<span class="sd">            (float): β in units of eV^-1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot calculate β without a defined temperature&#39;</span>
                <span class="s1">&#39; please set .temp&#39;</span>
            <span class="p">)</span>

        <span class="n">k_b</span> <span class="o">=</span> <span class="mf">8.617333262e-5</span>  <span class="c1"># Boltzmann constant in eV / K</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">k_b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_bin_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For each window bin the observed zetas into a histogram&quot;&quot;&quot;</span>

        <span class="n">bin_centres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zeta_refs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta_refs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">n_bins</span>
        <span class="p">)</span>
        <span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_centres</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_centres</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Bin width: </span><span class="si">{</span><span class="n">bin_width</span><span class="si">}</span><span class="s1"> Å&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">:</span>
            <span class="n">window</span><span class="o">.</span><span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="n">bin_centres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">bin_centres</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_centres</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">window</span><span class="o">.</span><span class="n">bin</span><span class="p">()</span>

<div class="viewcode-block" id="UmbrellaSampling.wham">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.wham">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">wham</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">max_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct an unbiased distribution (on a grid) from a set of windows</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            tol: Tolerance on the convergence</span>

<span class="sd">            max_iterations: Maximum number of WHAM iterations to perform</span>

<span class="sd">            n_bins: Number of bins to use in the histogram (minus one) and</span>
<span class="sd">                    the number of reaction coordinate values plotted and</span>
<span class="sd">                    returned</span>

<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray, np.ndarray): Tuple containing the reaction coordinate</span>
<span class="sd">                                      and values of the free energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>  <span class="c1"># 1 / (k_B T)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_windows</span><span class="p">(</span><span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span>

        <span class="c1"># Discretised reaction coordinate</span>
        <span class="n">zetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zeta_refs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta_refs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">zetas</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">zetas</span><span class="p">)</span>  <span class="c1"># P(ζ) uniform distribution</span>
        <span class="n">p_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Start with P(ζ)_(-1) = ∞</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">converged</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_prev</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="c1"># Equation 8.8.18 from Tuckerman, p. 343</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w_k</span><span class="o">.</span><span class="n">hist</span> <span class="k">for</span> <span class="n">w_k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">w_k</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">w_k</span><span class="o">.</span><span class="n">free_energy</span> <span class="o">-</span> <span class="n">w_k</span><span class="o">.</span><span class="n">bias_energies</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">w_k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">w_k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">:</span>
                <span class="c1"># Equation 8.8.19 from Tuckerman, p. 343</span>
                <span class="n">w_k</span><span class="o">.</span><span class="n">free_energy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">w_k</span><span class="o">.</span><span class="n">bias_energies</span> <span class="o">*</span> <span class="n">beta</span><span class="p">))</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">converged</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WHAM converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">p_prev</span> <span class="o">=</span> <span class="n">p</span>

        <span class="n">_plot_and_save_free_energy</span><span class="p">(</span>
            <span class="n">free_energies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">free_energies</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">zetas</span><span class="o">=</span><span class="n">zetas</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">zetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energies</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="UmbrellaSampling.umbrella_integration">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.umbrella_integration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">umbrella_integration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform umbrella integration on the umbrella windows to un-bias the</span>
<span class="sd">        probability distribution. Such that the PMF becomes</span>

<span class="sd">        .. math::</span>
<span class="sd">            dA/dq = Σ_i p_i(q) dA^u_i/ dq</span>

<span class="sd">        where the sum runs over the windows. Also plot and save the resulting</span>
<span class="sd">        free energy.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            n_bins: Number of bins to use in the histogram (minus one) and</span>
<span class="sd">                    the number of reaction coordinate values plotted and</span>
<span class="sd">                    returned</span>

<span class="sd">        Returns:</span>

<span class="sd">            (np.ndarray, np.ndarray): Tuple containing the reaction coordinate</span>
<span class="sd">                                      and values of the free energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_windows</span><span class="p">(</span><span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span>

        <span class="c1"># Discretised reaction coordinate</span>
        <span class="n">zetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zeta_refs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeta_refs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">n_bins</span><span class="p">)</span>
        <span class="n">zetas_spacing</span> <span class="o">=</span> <span class="n">zetas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">zetas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">dA_dq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">zetas</span><span class="p">)</span>
        <span class="n">free_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">zetas</span><span class="p">)</span>
        <span class="n">sum_a</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">):</span>
            <span class="n">a_i</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">window</span><span class="o">.</span><span class="n">gaussian_pdf</span><span class="p">(</span><span class="n">zetas</span><span class="p">)</span>
            <span class="n">dA_dq</span> <span class="o">+=</span> <span class="n">a_i</span> <span class="o">*</span> <span class="n">window</span><span class="o">.</span><span class="n">dAu_dq</span><span class="p">(</span><span class="n">zetas</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span>
            <span class="n">sum_a</span> <span class="o">+=</span> <span class="n">a_i</span>

        <span class="c1"># Normalise</span>
        <span class="n">dA_dq</span> <span class="o">/=</span> <span class="n">sum_a</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zetas</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">free_energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">simpson</span><span class="p">(</span>
                    <span class="n">dA_dq</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">zetas</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">dx</span><span class="o">=</span><span class="n">zetas_spacing</span>
                <span class="p">)</span>

        <span class="n">_plot_and_save_free_energy</span><span class="p">(</span><span class="n">free_energies</span><span class="o">=</span><span class="n">free_energies</span><span class="p">,</span> <span class="n">zetas</span><span class="o">=</span><span class="n">zetas</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zetas</span><span class="p">,</span> <span class="n">free_energies</span></div>


<div class="viewcode-block" id="UmbrellaSampling.save">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;umbrella&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the windows in this US to a folder containing each window as .txt</span>
<span class="sd">        files within in</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot save US to </span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1"> - had no windows&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">):</span>
            <span class="n">window</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;window_</span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="UmbrellaSampling.load">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data from a set of saved windows&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Loading from a folder was not possible as &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">folder_name</span><span class="si">}</span><span class="s1"> is not a valid folder&#39;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_name</span><span class="p">,</span> <span class="s1">&#39;window_*.txt&#39;</span><span class="p">)):</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">_Window</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="UmbrellaSampling.from_folder">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.from_folder">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_folder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;UmbrellaSampling&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an umbrella sampling instance from a folder containing the</span>
<span class="sd">        window data</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>
<span class="sd">            folder_name:</span>

<span class="sd">            temp: Temperature (K)</span>

<span class="sd">        Returns:</span>
<span class="sd">            (mlptrain.sampling.umbrella.UmbrellaSampling):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">us</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">zeta_func</span><span class="o">=</span><span class="n">DummyCoordinate</span><span class="p">(),</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">us</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder_name</span><span class="o">=</span><span class="n">folder_name</span><span class="p">)</span>
        <span class="n">us</span><span class="o">.</span><span class="n">_order_windows_by_zeta_ref</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">us</span></div>


<div class="viewcode-block" id="UmbrellaSampling.from_folders">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.umbrella.html#mlptrain.UmbrellaSampling.from_folders">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_folders</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;UmbrellaSampling&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a set of individual umbrella sampling simulations in to a single</span>
<span class="sd">        one</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>
<span class="sd">            *args: Names of folders</span>

<span class="sd">            temp: Temperature (K)</span>

<span class="sd">        Returns:</span>
<span class="sd">            (mlptrain.sampling.umbrella.UmbrellaSampling):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">us</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">zeta_func</span><span class="o">=</span><span class="n">DummyCoordinate</span><span class="p">(),</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">folder_name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">us</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">folder_name</span><span class="o">=</span><span class="n">folder_name</span><span class="p">)</span>

        <span class="n">us</span><span class="o">.</span><span class="n">_order_windows_by_zeta_ref</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">us</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_order_windows_by_zeta_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sort the windows in this umbrella by ζ_ref&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">windows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">window</span><span class="p">:</span> <span class="n">window</span><span class="o">.</span><span class="n">zeta_ref</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">_FittedGaussian</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gaussian defined by three parameters:</span>

<span class="sd">        a * exp(-(x - b)^2 / (2 * c^2))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mean of the Normal distribution, of which this is an approx.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Standard deviation of the Normal distribution&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_plot_and_save_free_energy</span><span class="p">(</span>
    <span class="n">free_energies</span><span class="p">,</span> <span class="n">zetas</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kcal mol-1&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the free energy against the reaction coordinate and saves</span>
<span class="sd">    the corresponding values as a .txt file</span>

<span class="sd">    -----------------------------------------------------------------------</span>
<span class="sd">    Arguments:</span>

<span class="sd">        zetas: Values of the reaction coordinate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

    <span class="n">free_energies</span> <span class="o">=</span> <span class="n">convert_ase_energy</span><span class="p">(</span><span class="n">energy_array</span><span class="o">=</span><span class="n">free_energies</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

    <span class="n">rel_free_energies</span> <span class="o">=</span> <span class="n">free_energies</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">free_energies</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zetas</span><span class="p">,</span> <span class="n">rel_free_energies</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;umbrella_free_energy.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">free_energy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zetas</span><span class="p">,</span> <span class="n">rel_free_energies</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">zeta</span><span class="p">,</span> <span class="n">free_energy</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Reaction coordinate / Å&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ΔG / </span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;umbrella_free_energy.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Duarte group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>