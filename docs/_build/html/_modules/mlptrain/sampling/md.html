

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mlptrain.sampling.md &mdash; mlp-train  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            mlp-train
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mlp-train</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mlptrain.sampling.md</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mlptrain.sampling.md</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">autode</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ade</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.configurations</span><span class="w"> </span><span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">Trajectory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PlumedBias</span><span class="p">,</span>
    <span class="n">PlumedCalculator</span><span class="p">,</span>
    <span class="n">plumed_setup</span><span class="p">,</span>
    <span class="n">get_colvar_filename</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.box</span><span class="w"> </span><span class="kn">import</span> <span class="n">Box</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">work_in_tmp_dir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.md.velocitydistribution</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxwellBoltzmannDistribution</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io.trajectory</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trajectory</span> <span class="k">as</span> <span class="n">ASETrajectory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.md.nptberendsen</span><span class="w"> </span><span class="kn">import</span> <span class="n">NPTBerendsen</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.md.langevin</span><span class="w"> </span><span class="kn">import</span> <span class="n">Langevin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.md.verlet</span><span class="w"> </span><span class="kn">import</span> <span class="n">VelocityVerlet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">read</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">ase_units</span>


<div class="viewcode-block" id="run_mlp_md">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.md.html#mlptrain.sampling.md.run_mlp_md">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
    <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">init_temp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fbond_energy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bbond_energy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bias</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">restart_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">copied_substrings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">kept_substrings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;mlptrain.Trajectory&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run molecular dynamics on a system using a MLP to predict energies and</span>
<span class="sd">    forces and ASE to drive dynamics. The function is executed in a temporary</span>
<span class="sd">    directory. Note that NPT simulations are currently only implemented in</span>
<span class="sd">    production runs and not in active learning.</span>

<span class="sd">    directory. Note that NPT simulations are currently only implemented in</span>
<span class="sd">    production runs and not in active learning.</span>


<span class="sd">    ---------------------------------------------------------------------------</span>
<span class="sd">    Arguments:</span>

<span class="sd">        configuration: Configuration from which the simulation is started</span>
<span class="sd">                       (if restart is False)</span>

<span class="sd">        mlp: Machine learnt potential</span>

<span class="sd">        temp: Temperature in K to initialise velocities and to run</span>
<span class="sd">              NVT MD, if temp=0 then will run NVE</span>

<span class="sd">        init_temp: (float | None) Initial temperature to initialise momenta</span>
<span class="sd">                   with. If None then will be set to temp</span>

<span class="sd">        dt: (float) Time-step in fs</span>

<span class="sd">        interval: (int) Interval between saving the geometry</span>

<span class="sd">        pressure: pressure in bar to run Berendsen NPT MD, temperature</span>
<span class="sd">              and pressure must also be specified in order to run NPT dynamics.</span>

<span class="sd">        compress: compressibility in bar^-1 to run Berendsen NPT MD,</span>
<span class="sd">              temperature and pressure must also be specified in order to</span>
<span class="sd">              run NPT dynamics.</span>

<span class="sd">        bbond_energy: (dict | None) Additional energy to add to a breaking</span>
<span class="sd">                         bond. e.g. bbond_energy={(0, 1), 0.1} Adds 0.1 eV</span>
<span class="sd">                         to the &#39;bond&#39; between atoms 0 and 1 as velocities</span>
<span class="sd">                         shared between the atoms in the breaking bond direction</span>

<span class="sd">        fbond_energy: (dict | None) As bbond_energy but in the direction to</span>
<span class="sd">                         form a bond</span>

<span class="sd">        bias: (mlptrain.Bias | mlptrain.PlumedBias) mlp-train constrain</span>
<span class="sd">              to use in the dynamics</span>

<span class="sd">        restart_files: List of files which are needed for restarting the</span>
<span class="sd">                       simulation</span>

<span class="sd">        kept_substrings: List of substrings with which files are copied back</span>
<span class="sd">                         from the temporary directory</span>
<span class="sd">                         e.g. &#39;.json&#39;, &#39;trajectory_1.traj&#39;</span>

<span class="sd">        copied_substrings: List of substrings with which files are copied</span>
<span class="sd">                           to the temporary directory. Files required for MLPs</span>
<span class="sd">                           are added to the list automatically</span>
<span class="sd">    ---------------</span>
<span class="sd">    Keyword Arguments:</span>

<span class="sd">        {fs, ps, ns}: Simulation time in some units</span>

<span class="sd">        {save_fs, save_ps, save_ns}: Trajectory saving interval in some units</span>

<span class="sd">        constraints: (List) List of ASE constraints to use in the dynamics</span>
<span class="sd">                            e.g. [ase.constraints.Hookean(a1, a2, k, rt)]</span>

<span class="sd">        write_plumed_setup: (bool) If True saves the PLUMED input file as</span>
<span class="sd">                            plumed_setup.dat</span>

<span class="sd">    Returns:</span>

<span class="sd">        (mlptrain.Trajectory):</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">restart</span> <span class="o">=</span> <span class="n">restart_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">copied_substrings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">copied_substrings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">kept_substrings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kept_substrings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">copied_substrings_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">copied_substrings</span><span class="p">)</span>
    <span class="n">kept_substrings_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kept_substrings</span><span class="p">)</span>

    <span class="n">copied_substrings_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.pth&#39;</span><span class="p">,</span> <span class="s1">&#39;.model&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_al_trajs&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">kept_substrings_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;.traj&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Restarting MLP MD&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restart_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Restart files must be a list&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">restart_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s1">&#39;Restart files must be a list of strings &#39;</span>
                    <span class="s1">&#39;specifying filenames&#39;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.traj&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">restart_files</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Restaring a simulation requires a .traj file &#39;</span>
                <span class="s1">&#39;from the previous simulation&#39;</span>
            <span class="p">)</span>

        <span class="n">copied_substrings_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">restart_files</span><span class="p">)</span>
        <span class="n">kept_substrings_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">restart_files</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running MLP MD&#39;</span><span class="p">)</span>

    <span class="n">decorator</span> <span class="o">=</span> <span class="n">work_in_tmp_dir</span><span class="p">(</span>
        <span class="n">copied_substrings</span><span class="o">=</span><span class="n">copied_substrings_list</span><span class="p">,</span>
        <span class="n">kept_substrings</span><span class="o">=</span><span class="n">kept_substrings_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_run_mlp_md_decorated</span> <span class="o">=</span> <span class="n">decorator</span><span class="p">(</span><span class="n">_run_mlp_md</span><span class="p">)</span>

    <span class="n">traj</span> <span class="o">=</span> <span class="n">_run_mlp_md_decorated</span><span class="p">(</span>
        <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
        <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">,</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
        <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
        <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">,</span>
        <span class="n">init_temp</span><span class="o">=</span><span class="n">init_temp</span><span class="p">,</span>
        <span class="n">fbond_energy</span><span class="o">=</span><span class="n">fbond_energy</span><span class="p">,</span>
        <span class="n">bbond_energy</span><span class="o">=</span><span class="n">bbond_energy</span><span class="p">,</span>
        <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
        <span class="n">restart_files</span><span class="o">=</span><span class="n">restart_files</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">traj</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
    <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">init_temp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fbond_energy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bbond_energy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">bias</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">restart_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;mlptrain.Trajectory&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run molecular dynamics on a system using a MLP to predict energies and</span>
<span class="sd">    forces and ASE to drive dynamics</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">restart</span> <span class="o">=</span> <span class="n">restart_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">n_cores</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_cores&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;n_cores&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_cores</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">n_cores</span><span class="si">}</span><span class="s1"> core(s) for MLP MD&#39;</span><span class="p">)</span>

    <span class="c1"># Transform dt from fs into ASE time units (for dynamics only)</span>
    <span class="n">dt_ase</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">ase_units</span><span class="o">.</span><span class="n">fs</span>
    <span class="n">n_steps</span> <span class="o">=</span> <span class="n">_n_simulation_steps</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">restart</span> <span class="ow">and</span> <span class="n">n_steps</span> <span class="o">%</span> <span class="n">interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Current implementation requires the number &#39;</span>
            <span class="s1">&#39;of steps to be divisible by the interval &#39;</span>
            <span class="s1">&#39;if the simulation is restarted&#39;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">mlp</span><span class="o">.</span><span class="n">requires_non_zero_box_size</span> <span class="ow">and</span> <span class="n">configuration</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Assuming vaccum simulation. Box size = 1000 nm^3&#39;</span><span class="p">)</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>

    <span class="n">ase_atoms</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">ase_atoms</span>
    <span class="n">traj_name</span> <span class="o">=</span> <span class="n">_get_traj_name</span><span class="p">(</span><span class="n">restart_files</span><span class="o">=</span><span class="n">restart_files</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">_set_momenta_and_geometry</span><span class="p">(</span>
        <span class="n">ase_atoms</span><span class="o">=</span><span class="n">ase_atoms</span><span class="p">,</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">init_temp</span> <span class="k">if</span> <span class="n">init_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">temp</span><span class="p">,</span>
        <span class="n">bbond_energy</span><span class="o">=</span><span class="n">bbond_energy</span><span class="p">,</span>
        <span class="n">fbond_energy</span><span class="o">=</span><span class="n">fbond_energy</span><span class="p">,</span>
        <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span>
        <span class="n">traj_name</span><span class="o">=</span><span class="n">traj_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ase_traj</span> <span class="o">=</span> <span class="n">_initialise_traj</span><span class="p">(</span>
        <span class="n">ase_atoms</span><span class="o">=</span><span class="n">ase_atoms</span><span class="p">,</span>
        <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span>
        <span class="n">traj_name</span><span class="o">=</span><span class="n">traj_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If MD is restarted, energies of frames from the previous trajectory</span>
    <span class="c1"># are not loaded. Setting them to None</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ase_traj</span><span class="p">))]</span>
    <span class="n">biased_energies</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">bias_energies</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

    <span class="n">n_previous_steps</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ase_traj</span><span class="p">)</span>
    <span class="n">_attach_calculator_and_constraints</span><span class="p">(</span>
        <span class="n">ase_atoms</span><span class="o">=</span><span class="n">ase_atoms</span><span class="p">,</span>
        <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">,</span>
        <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
        <span class="n">dt_ase</span><span class="o">=</span><span class="n">dt_ase</span><span class="p">,</span>
        <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span>
        <span class="n">n_previous_steps</span><span class="o">=</span><span class="n">n_previous_steps</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_run_dynamics</span><span class="p">(</span>
        <span class="n">ase_atoms</span><span class="o">=</span><span class="n">ase_atoms</span><span class="p">,</span>
        <span class="n">ase_traj</span><span class="o">=</span><span class="n">ase_traj</span><span class="p">,</span>
        <span class="n">traj_name</span><span class="o">=</span><span class="n">traj_name</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
        <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
        <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
        <span class="n">dt_ase</span><span class="o">=</span><span class="n">dt_ase</span><span class="p">,</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
        <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
        <span class="n">biased_energies</span><span class="o">=</span><span class="n">biased_energies</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Duplicate frames removed only if PLUMED bias is initialised not from file</span>
    <span class="k">if</span> <span class="n">restart</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">PlumedBias</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bias</span><span class="o">.</span><span class="n">from_file</span><span class="p">:</span>
        <span class="n">_remove_colvar_duplicate_frames</span><span class="p">(</span><span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">traj</span> <span class="o">=</span> <span class="n">_convert_ase_traj</span><span class="p">(</span><span class="n">traj_name</span><span class="o">=</span><span class="n">traj_name</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">energy</span><span class="p">,</span> <span class="n">biased_energy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">biased_energies</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">biased_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bias_energy</span> <span class="o">=</span> <span class="n">biased_energy</span> <span class="o">-</span> <span class="n">energy</span>
            <span class="n">bias_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias_energy</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">bias_energy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">bias_energies</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">update_attr_from</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">predicted</span> <span class="o">=</span> <span class="n">energy</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">bias_energy</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">interval</span> <span class="o">*</span> <span class="n">i</span>

    <span class="k">return</span> <span class="n">traj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_attach_calculator_and_constraints</span><span class="p">(</span>
    <span class="n">ase_atoms</span><span class="p">:</span> <span class="s1">&#39;ase.atoms.Atoms&#39;</span><span class="p">,</span>
    <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
    <span class="n">bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;mlptrain.Bias&#39;</span><span class="p">,</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">]],</span>
    <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dt_ase</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">restart</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">n_previous_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the calculator and attach it to the ase_atoms together with bias</span>
<span class="sd">    and constraints</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">PlumedBias</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using PLUMED bias for MLP MD&#39;</span><span class="p">)</span>

        <span class="n">setup</span> <span class="o">=</span> <span class="n">plumed_setup</span><span class="p">(</span><span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">bias</span><span class="o">.</span><span class="n">write_cv_files</span><span class="p">()</span>

        <span class="n">plumed_calc</span> <span class="o">=</span> <span class="n">PlumedCalculator</span><span class="p">(</span>
            <span class="n">calc</span><span class="o">=</span><span class="n">mlp</span><span class="o">.</span><span class="n">ase_calculator</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">setup</span><span class="p">,</span>
            <span class="n">timestep</span><span class="o">=</span><span class="n">dt_ase</span><span class="p">,</span>
            <span class="n">atoms</span><span class="o">=</span><span class="n">ase_atoms</span><span class="p">,</span>
            <span class="n">kT</span><span class="o">=</span><span class="n">temp</span> <span class="o">*</span> <span class="n">ase_units</span><span class="o">.</span><span class="n">kB</span><span class="p">,</span>
            <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
            <span class="n">plumed_calc</span><span class="o">.</span><span class="n">istep</span> <span class="o">=</span> <span class="n">n_previous_steps</span>

        <span class="n">ase_atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">plumed_calc</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ase_atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">ase_calculator</span>

    <span class="k">if</span> <span class="s1">&#39;constraints&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>

    <span class="n">ase_atoms</span><span class="o">.</span><span class="n">set_constraint</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_run_dynamics</span><span class="p">(</span>
    <span class="n">ase_atoms</span><span class="p">:</span> <span class="s1">&#39;ase.atoms.Atoms&#39;</span><span class="p">,</span>
    <span class="n">ase_traj</span><span class="p">:</span> <span class="s1">&#39;ase.io.trajectory.Trajectory&#39;</span><span class="p">,</span>
    <span class="n">traj_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">dt_ase</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">energies</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">biased_energies</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">pressure</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialise dynamics object and run dynamics&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pressure</span><span class="p">,</span> <span class="n">compress</span><span class="p">]])</span> <span class="ow">and</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Run NPT dynamics if pressure and compressibility are specified</span>
        <span class="n">pressure_au</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">*</span> <span class="n">ase_units</span><span class="o">.</span><span class="n">bar</span>
        <span class="n">compress_au</span> <span class="o">=</span> <span class="n">compress</span> <span class="o">/</span> <span class="n">ase_units</span><span class="o">.</span><span class="n">bar</span>
        <span class="n">dyn</span> <span class="o">=</span> <span class="n">NPTBerendsen</span><span class="p">(</span>
            <span class="n">ase_atoms</span><span class="p">,</span>
            <span class="n">dt_ase</span><span class="p">,</span>
            <span class="n">temperature_K</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">pressure_au</span><span class="o">=</span><span class="n">pressure_au</span><span class="p">,</span>
            <span class="n">compressibility_au</span><span class="o">=</span><span class="n">compress_au</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Initialising NPT Berendsen dynamics at </span><span class="si">{</span><span class="n">pressure</span><span class="si">}</span><span class="s1"> bar and </span><span class="si">{</span><span class="n">temp</span><span class="si">}</span><span class="s1"> K&#39;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Default Langevin NVT</span>
        <span class="n">dyn</span> <span class="o">=</span> <span class="n">Langevin</span><span class="p">(</span><span class="n">ase_atoms</span><span class="p">,</span> <span class="n">dt_ase</span><span class="p">,</span> <span class="n">temperature_K</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span> <span class="n">friction</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initialising NVT Langevin dynamics at </span><span class="si">{</span><span class="n">temp</span><span class="si">}</span><span class="s1"> K&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Otherwise NVE</span>
        <span class="n">dyn</span> <span class="o">=</span> <span class="n">VelocityVerlet</span><span class="p">(</span><span class="n">ase_atoms</span><span class="p">,</span> <span class="n">dt_ase</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Initialising NVE dynamics&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append_unbiased_energy</span><span class="p">():</span>
        <span class="n">energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ase_atoms</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">(</span><span class="n">ase_atoms</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append_biased_energy</span><span class="p">():</span>
        <span class="n">biased_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ase_atoms</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_trajectory</span><span class="p">():</span>
        <span class="n">_save_trajectory</span><span class="p">(</span><span class="n">ase_traj</span><span class="p">,</span> <span class="n">traj_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">dyn</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">append_unbiased_energy</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">append_biased_energy</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">ase_traj</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;save_fs&#39;</span><span class="p">,</span> <span class="s1">&#39;save_ps&#39;</span><span class="p">,</span> <span class="s1">&#39;save_ns&#39;</span><span class="p">]):</span>
        <span class="n">dyn</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">save_trajectory</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">_traj_saving_interval</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running </span><span class="si">{</span><span class="n">n_steps</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> steps with a timestep of </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s1"> fs&#39;</span><span class="p">)</span>
    <span class="n">dyn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ase_atoms</span><span class="o">.</span><span class="n">calc</span><span class="p">,</span> <span class="n">PlumedCalculator</span><span class="p">):</span>
        <span class="c1"># The calling process waits until PLUMED process has finished</span>
        <span class="n">ase_atoms</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">plumed</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_save_trajectory</span><span class="p">(</span>
    <span class="n">ase_traj</span><span class="p">:</span> <span class="s1">&#39;ase.io.trajectory.Trajectory&#39;</span><span class="p">,</span> <span class="n">traj_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the trajectory with a unique name based on the current simulation</span>
<span class="sd">    time</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Prevents initial trajectory save at time == 0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ase_traj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">specified_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;save_ns&#39;</span><span class="p">,</span> <span class="s1">&#39;save_fs&#39;</span><span class="p">,</span> <span class="s1">&#39;save_ps&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">specified_key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">break</span>

    <span class="n">traj_basename</span> <span class="o">=</span> <span class="n">traj_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">time_units</span> <span class="o">=</span> <span class="n">specified_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">saving_interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">specified_key</span><span class="p">]</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">saving_interval</span>
    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">traj_basename</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">time</span><span class="si">}{</span><span class="n">time_units</span><span class="si">}</span><span class="s1">.traj&#39;</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">+=</span> <span class="n">saving_interval</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
        <span class="n">src</span><span class="o">=</span><span class="n">traj_name</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">traj_basename</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">time</span><span class="si">}{</span><span class="n">time_units</span><span class="si">}</span><span class="s1">.traj&#39;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_traj_name</span><span class="p">(</span><span class="n">restart_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the name of the trajectory which is going to be created</span>
<span class="sd">    (or on to which the new frames will be appended in the case of restart)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">restart_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;idx&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">traj_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;trajectory_</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.traj&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">traj_name</span> <span class="o">=</span> <span class="s1">&#39;trajectory.traj&#39;</span>

        <span class="k">return</span> <span class="n">traj_name</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">restart_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.traj&#39;</span><span class="p">):</span>
                <span class="n">traj_name</span> <span class="o">=</span> <span class="n">filename</span>

                <span class="k">return</span> <span class="n">traj_name</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_ase_traj</span><span class="p">(</span>
    <span class="n">traj_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;mlptrain.Bias&#39;</span><span class="p">,</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">]],</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;mlptrain.Trajectory&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert an ASE trajectory into an mlptrain Trajectory&quot;&quot;&quot;</span>

    <span class="n">ase_traj</span> <span class="o">=</span> <span class="n">ASETrajectory</span><span class="p">(</span><span class="n">traj_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">mlt_traj</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">()</span>

    <span class="c1"># Iterate through each frame (set of atoms) in the trajectory</span>
    <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">ase_traj</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">ade</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span><span class="p">]</span>

        <span class="n">cell</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">cell</span><span class="p">[:]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">([</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>

        <span class="c1"># Set the atom_pair_list of every atom in the configuration</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()):</span>
            <span class="n">config</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">=</span> <span class="n">position</span>

        <span class="n">mlt_traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="n">PlumedBias</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bias</span><span class="o">.</span><span class="n">from_file</span><span class="p">:</span>
        <span class="n">_attach_plumed_coordinates</span><span class="p">(</span><span class="n">mlt_traj</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mlt_traj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_attach_plumed_coordinates</span><span class="p">(</span>
    <span class="n">mlt_traj</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Trajectory&#39;</span><span class="p">,</span> <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attach PLUMED collective variable values to configurations in the</span>
<span class="sd">    trajectory if all colvar files have been printed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">colvar_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_colvar_filename</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">bias</span><span class="o">.</span><span class="n">cvs</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">colvar_filenames</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">mlt_traj</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">plumed_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bias</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bias</span><span class="o">.</span><span class="n">cvs</span><span class="p">):</span>
            <span class="n">colvar_fname</span> <span class="o">=</span> <span class="n">colvar_filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cv_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">colvar_fname</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mlt_traj</span><span class="p">):</span>
                <span class="n">config</span><span class="o">.</span><span class="n">plumed_coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_momenta_and_geometry</span><span class="p">(</span>
    <span class="n">ase_atoms</span><span class="p">:</span> <span class="s1">&#39;ase.atoms.Atoms&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">bbond_energy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">fbond_energy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">restart</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">traj_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the initial momenta and geometry of the starting configuration&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">restart</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initialising initial velocities for </span><span class="si">{</span><span class="n">temp</span><span class="si">}</span><span class="s1"> K&#39;</span><span class="p">)</span>

            <span class="n">MaxwellBoltzmannDistribution</span><span class="p">(</span>
                <span class="n">ase_atoms</span><span class="p">,</span> <span class="n">temperature_K</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">RandomState</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set the momenta to zero</span>
            <span class="n">ase_atoms</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;momenta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ase_atoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add_momenta</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">energy</span><span class="p">):</span>
            <span class="n">masses</span> <span class="o">=</span> <span class="n">ase_atoms</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()</span>
            <span class="n">ase_atoms</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;momenta&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">energy</span><span class="p">)</span> <span class="o">*</span> <span class="n">vector</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">ase_atoms</span><span class="o">.</span><span class="n">positions</span>
        <span class="k">if</span> <span class="n">bbond_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding breaking bond momenta&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">atom_idxs</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">bbond_energy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">atom_idxs</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding </span><span class="si">{</span><span class="n">energy</span><span class="si">}</span><span class="s1"> eV to break bond: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1">#    vec</span>
                <span class="c1">#   &lt;---   i--j         where i and j are two atoms</span>
                <span class="c1">#</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">vec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>  <span class="c1"># normalise</span>

                <span class="n">add_momenta</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">)</span>
                <span class="n">add_momenta</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">vector</span><span class="o">=-</span><span class="n">vec</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fbond_energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom_idxs</span><span class="p">,</span> <span class="n">energy</span> <span class="ow">in</span> <span class="n">fbond_energy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">atom_idxs</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding </span><span class="si">{</span><span class="n">energy</span><span class="si">}</span><span class="s1"> eV to form bond: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1">#    vec</span>
                <span class="c1">#   ---&gt;   i--j         where i and j are two atoms</span>
                <span class="c1">#</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">vec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>  <span class="c1"># normalise</span>

                <span class="n">add_momenta</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">)</span>
                <span class="n">add_momenta</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">vector</span><span class="o">=-</span><span class="n">vec</span><span class="p">,</span> <span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Initialising starting geometry and momenta from the &#39;</span>
            <span class="s1">&#39;last configuration&#39;</span>
        <span class="p">)</span>

        <span class="n">last_configuration</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">traj_name</span><span class="p">)</span>

        <span class="n">ase_atoms</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">last_configuration</span><span class="o">.</span><span class="n">get_positions</span><span class="p">())</span>
        <span class="n">ase_atoms</span><span class="o">.</span><span class="n">set_momenta</span><span class="p">(</span><span class="n">last_configuration</span><span class="o">.</span><span class="n">get_momenta</span><span class="p">())</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_initialise_traj</span><span class="p">(</span>
    <span class="n">ase_atoms</span><span class="p">:</span> <span class="s1">&#39;ase.atoms.Atoms&#39;</span><span class="p">,</span>
    <span class="n">restart</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">traj_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">remove_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ase.io.trajectory.Trajectory&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialise ASE trajectory object&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">restart</span><span class="p">:</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">ASETrajectory</span><span class="p">(</span><span class="n">traj_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ase_atoms</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">previous_traj</span> <span class="o">=</span> <span class="n">ASETrajectory</span><span class="p">(</span><span class="n">traj_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ase_atoms</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_last</span><span class="p">:</span>
            <span class="c1"># Remove the last frame to avoid duplicate frames</span>
            <span class="n">previous_atoms</span> <span class="o">=</span> <span class="n">previous_traj</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_atoms</span> <span class="o">=</span> <span class="n">previous_traj</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">traj_name</span><span class="p">)</span>

        <span class="n">traj</span> <span class="o">=</span> <span class="n">ASETrajectory</span><span class="p">(</span><span class="n">traj_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ase_atoms</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">previous_atoms</span><span class="p">:</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">traj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_n_simulation_steps</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the number of simulation steps from a set of keyword</span>
<span class="sd">    arguments e.g. kwargs = {&#39;fs&#39;: 100}</span>

<span class="sd">    ---------------------------------------------------------------------------</span>
<span class="sd">    Arguments:</span>
<span class="sd">        dt: Timestep in fs</span>

<span class="sd">    Returns:</span>
<span class="sd">        (int): Number of simulation steps to perform</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="mf">0.09</span> <span class="ow">or</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unexpectedly small or large timestep - is it in fs?&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;ps&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">time_fs</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="s1">&#39;fs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">time_fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fs&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="s1">&#39;ns&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">time_fs</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Simulation time not found&#39;</span><span class="p">)</span>

    <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_fs</span> <span class="o">/</span> <span class="n">dt</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Run at least one step</span>

    <span class="k">return</span> <span class="n">n_steps</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_traj_saving_interval</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the interval at which a trajectory is saved&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;save_ps&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">time_fs</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;save_ps&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="s1">&#39;save_fs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">time_fs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;save_fs&#39;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="s1">&#39;save_ns&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">time_fs</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;save_ns&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Saving time not found&#39;</span><span class="p">)</span>

    <span class="n">saving_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_fs</span> <span class="o">/</span> <span class="n">dt</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">saving_interval</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_remove_colvar_duplicate_frames</span><span class="p">(</span>
    <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove duplicate frames from generated colvar files when using PLUMED</span>
<span class="sd">    bias</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">colvar_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_colvar_filename</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">bias</span><span class="o">.</span><span class="n">cvs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">colvar_filenames</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">duplicate_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#!&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># First frame before redundant header is a duplicate</span>
                <span class="n">duplicate_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">duplicate_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Duplicate frame in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1"> was not found&#39;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">duplicate_index</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Duarte group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>