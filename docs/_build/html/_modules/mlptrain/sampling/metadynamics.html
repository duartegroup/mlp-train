

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mlptrain.sampling.metadynamics &mdash; mlp-train  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            mlp-train
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mlp-train</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mlptrain.sampling.metadynamics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mlptrain.sampling.metadynamics</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ase</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">autode</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ade</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">subprocess</span><span class="w"> </span><span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">ase_units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">read</span> <span class="k">as</span> <span class="n">ase_read</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">write</span> <span class="k">as</span> <span class="n">ase_write</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.io.trajectory</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trajectory</span> <span class="k">as</span> <span class="n">ASETrajectory</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.configurations</span><span class="w"> </span><span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">ConfigurationSet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.md</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_mlp_md</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PlumedBias</span><span class="p">,</span>
    <span class="n">plumed_setup</span><span class="p">,</span>
    <span class="n">plot_cv_versus_time</span><span class="p">,</span>
    <span class="n">plot_cv1_and_cv2</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">work_in_tmp_dir</span><span class="p">,</span>
    <span class="n">unique_name</span><span class="p">,</span>
    <span class="n">move_files</span><span class="p">,</span>
    <span class="n">convert_ase_time</span><span class="p">,</span>
    <span class="n">convert_ase_energy</span><span class="p">,</span>
    <span class="n">convert_exponents</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="Metadynamics">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Metadynamics</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metadynamics class for running biased molecular dynamics using</span>
<span class="sd">    metadynamics bias and analysing the results&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cvs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="s1">&#39;mlptrain._PlumedCV&#39;</span><span class="p">],</span> <span class="s1">&#39;mlptrain._PlumedCV&#39;</span><span class="p">],</span>
        <span class="n">bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Molecular dynamics using metadynamics bias. Used for calculating free</span>
<span class="sd">        energies (by using well-tempered metadynamics bias) and sampling</span>
<span class="sd">        configurations for active learning.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            cvs: Sequence of PLUMED collective variables</span>

<span class="sd">            bias: PLUMED bias which can be supplied if additional collective</span>
<span class="sd">                  variables are required,</span>
<span class="sd">                  e.g. Metadynamics(cvs=cv1, bias=PlumedBias(cvs=(cv1, cv2)),</span>
<span class="sd">                  where cv1 will be biased using metadynamics, and cv2 might</span>
<span class="sd">                  be an additional CV with WALLS to constrain the system</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bias</span><span class="o">.</span><span class="n">from_file</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot initialise Metadynamics using &#39;</span>
                    <span class="s1">&#39;PlumedBias initialised from a file&#39;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">bias</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">PlumedBias</span><span class="p">(</span><span class="n">cvs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">_set_metad_cvs</span><span class="p">(</span><span class="n">cvs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_run_parameters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_cvs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of collective variables used in metadynamics&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">n_metad_cvs</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">kbt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Value of k_B*T in ASE units&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ase_units</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span>

<div class="viewcode-block" id="Metadynamics.estimate_width">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.estimate_width">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_width</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">configurations</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span> <span class="s1">&#39;mlptrain.ConfigurationSet&#39;</span>
        <span class="p">],</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate optimal widths (σ) to be used in metadynamics.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            configurations: A set of all known minima configurations that are</span>
<span class="sd">                            likely to be visited during metadynamics</span>

<span class="sd">            mlp: Machine learnt potential</span>

<span class="sd">            temp: (float) Temperature in K to initialise velocities and to run</span>
<span class="sd">                  NVT MD. Must be positive</span>

<span class="sd">            interval: (int) Interval between saving the geometry</span>

<span class="sd">            dt: (float) Time-step in fs</span>

<span class="sd">            plot: (bool) If True plots trajectories of collective variables as</span>
<span class="sd">                  a function of time</span>

<span class="sd">        -------------------</span>
<span class="sd">        Keyword Arguments:</span>

<span class="sd">            {fs, ps, ns}: Simulation time in some units</span>

<span class="sd">        -------------------</span>
<span class="sd">        Returns:</span>

<span class="sd">            (List): List of optimal width values for each CV,</span>
<span class="sd">                    e.g. [0.02, 0.03] for two CVs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">]):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">configuration_set</span> <span class="o">=</span> <span class="n">ConfigurationSet</span><span class="p">()</span>
        <span class="n">configuration_set</span> <span class="o">=</span> <span class="n">configuration_set</span> <span class="o">+</span> <span class="n">configurations</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Estimating optimal width (σ)&#39;</span><span class="p">)</span>

        <span class="n">width_processes</span><span class="p">,</span> <span class="n">all_widths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">n_processes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">configuration_set</span><span class="p">))</span>

        <span class="c1"># Spawn is likely to make it slower, but fork in combination</span>
        <span class="c1"># with plotting is likely to give errors on MacOS &gt; 10.13</span>
        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">configuration</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">configuration_set</span><span class="p">):</span>
                <span class="n">kwargs_single</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">kwargs_single</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">width_process</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_width_for_single</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">configuration</span><span class="p">,</span>
                        <span class="n">mlp</span><span class="p">,</span>
                        <span class="n">temp</span><span class="p">,</span>
                        <span class="n">dt</span><span class="p">,</span>
                        <span class="n">interval</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
                        <span class="n">plot</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">kwds</span><span class="o">=</span><span class="n">kwargs_single</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">width_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">width_process</span><span class="p">)</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">width_process</span> <span class="ow">in</span> <span class="n">width_processes</span><span class="p">:</span>
                <span class="n">all_widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">width_process</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">all_widths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_widths</span><span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Width estimation done in </span><span class="si">{</span><span class="p">(</span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;colvar_\w+_\d+\.dat&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;plumed_files/width_estimation&#39;</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\w+_config\d+\.pdf&#39;</span><span class="p">],</span> <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;width_estimation&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">opt_widths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_widths</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">opt_widths_strs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cv</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">,</span> <span class="n">opt_widths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cv</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">opt_widths_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">opt_widths_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimated widths: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opt_widths_strs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt_widths</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_width_for_single</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">,</span>
        <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate optimal widths (σ) for a single configuration&quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running MD simulation number </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">run_mlp_md</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
            <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">kept_substrings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.dat&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">widths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">:</span>
            <span class="n">colvar_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;colvar_</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.dat&#39;</span>

            <span class="n">cv_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">colvar_filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cv_array</span><span class="p">)</span>
            <span class="n">widths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">plot_cv_versus_time</span><span class="p">(</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">colvar_filename</span><span class="p">,</span>
                    <span class="n">cv_units</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;config</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">widths</span>

<div class="viewcode-block" id="Metadynamics.run_metadynamics">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.run_metadynamics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_metadynamics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">pace</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">biasfactor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">al_iter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_runs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">save_sep</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">all_to_xyz</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform multiple metadynamics runs in parallel, generate .xyz and .traj</span>
<span class="sd">        files containing trajectories of the runs, generate PLUMED files</span>
<span class="sd">        containing deposited gaussians and trajectories in terms of the CVs.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            configuration: Configuration from which the simulation is started</span>

<span class="sd">            mlp: Machine learnt potential</span>

<span class="sd">            temp: (float) Temperature in K to initialise velocities and to run</span>
<span class="sd">                          NVT MD. Must be positive</span>

<span class="sd">            interval: (int) Interval between saving the geometry</span>

<span class="sd">            dt: (float) Time-step in fs</span>

<span class="sd">            pace: (int) τ_G/dt, interval at which a new gaussian is placed</span>

<span class="sd">            height: (float) ω, initial height of placed gaussians (in eV)</span>

<span class="sd">            width: (List[float] | float | None) σ, standard deviation</span>
<span class="sd">                   (parameter describing the width) of placed gaussians,</span>
<span class="sd">                   if not supplied it is estimated automatically</span>

<span class="sd">            biasfactor: (float | None) γ, describes how quickly gaussians</span>
<span class="sd">                                       shrink, larger values make gaussians to</span>
<span class="sd">                                       be placed less sensitive to the bias</span>
<span class="sd">                                       potential</span>

<span class="sd">            al_iter: (int | None) If not None, can be used to load metadynamics</span>
<span class="sd">                                  bias generated during inherited-bias active</span>
<span class="sd">                                  learning. The index specifies from which AL</span>
<span class="sd">                                  iteration to load the bias</span>

<span class="sd">            n_runs: (int) Number of times to run metadynamics</span>

<span class="sd">            save_sep: (bool) If True saves trajectories of</span>
<span class="sd">                             each simulation separately</span>

<span class="sd">            all_to_xyz: (bool) If True all .traj trajectory files are saved as</span>
<span class="sd">                              .xyz files (when using save_fs, save_ps, save_ns)</span>

<span class="sd">            restart: (bool) If True restarts the most recent metadynamics</span>
<span class="sd">                            simulation</span>
<span class="sd">        -------------------</span>
<span class="sd">        Keyword Arguments:</span>

<span class="sd">            {fs, ps, ns}: Simulation time in some units</span>

<span class="sd">            {save_fs, save_ps, save_ns}: Trajectory saving interval</span>
<span class="sd">                                         in some units</span>

<span class="sd">            {grid_min, grid_max, grid_bin}: Grid parameters: if defined, the</span>
<span class="sd">                                            deposited gaussians are dumped to</span>
<span class="sd">                                            a grid that is used to compute</span>
<span class="sd">                                            the biased forces</span>

<span class="sd">            constraints: (List) List of ASE constraints to use in the dynamics</span>
<span class="sd">                                e.g. [ase.constraints.Hookean(a1, a2, k, rt)]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Height was not supplied, &#39;</span> <span class="s1">&#39;setting height to 0.5*k_B*T&#39;</span>
                <span class="p">)</span>
                <span class="n">height</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Height was not supplied&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">biasfactor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Temperature must be positive and non-zero for &#39;</span>
                <span class="s1">&#39;well-tempered metadynamics&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">al_iter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_inherited_bias</span><span class="p">(</span><span class="n">al_iter</span><span class="o">=</span><span class="n">al_iter</span><span class="p">,</span> <span class="n">n_runs</span><span class="o">=</span><span class="n">n_runs</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;load_metad_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_restart</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">n_runs</span><span class="o">=</span><span class="n">n_runs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Width parameters were not supplied to the &#39;</span>
                    <span class="s1">&#39;metadynamics simulation, estimating widths &#39;</span>
                    <span class="s1">&#39;automatically by performing an unbiased &#39;</span>
                    <span class="s1">&#39;simulation for 10 ps&#39;</span>
                <span class="p">)</span>

                <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_width</span><span class="p">(</span>
                    <span class="n">configurations</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span>
                <span class="p">)</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kept_substrings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.traj&#39;</span><span class="p">,</span> <span class="s1">&#39;.dat&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">_set_metad_params</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
            <span class="n">pace</span><span class="o">=</span><span class="n">pace</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
            <span class="n">biasfactor</span><span class="o">=</span><span class="n">biasfactor</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">metad_processes</span><span class="p">,</span> <span class="n">metad_trajs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">n_processes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span> <span class="n">n_runs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Running </span><span class="si">{</span><span class="n">n_runs</span><span class="si">}</span><span class="s1"> independent Metadynamics &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;simulation(s), </span><span class="si">{</span><span class="n">n_processes</span><span class="si">}</span><span class="s1"> simulation(s) run &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;in parallel, 1 walker per simulation&#39;</span>
        <span class="p">)</span>

        <span class="n">start_metad</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_runs</span><span class="p">):</span>
                <span class="c1"># Without copy kwargs is overwritten at every iteration</span>
                <span class="n">kwargs_single</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">kwargs_single</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">metad_process</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_single_metad</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">configuration</span><span class="p">,</span>
                        <span class="n">mlp</span><span class="p">,</span>
                        <span class="n">temp</span><span class="p">,</span>
                        <span class="n">interval</span><span class="p">,</span>
                        <span class="n">dt</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
                        <span class="n">al_iter</span><span class="p">,</span>
                        <span class="n">restart</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">kwds</span><span class="o">=</span><span class="n">kwargs_single</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">metad_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metad_process</span><span class="p">)</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">metad_process</span> <span class="ow">in</span> <span class="n">metad_processes</span><span class="p">:</span>
                <span class="n">metad_trajs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metad_process</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">finish_metad</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Metadynamics done in &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">finish_metad</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_metad</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> m&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Move .traj files into &#39;trajectories&#39; folder and compute .xyz files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_move_and_save_files</span><span class="p">(</span>
            <span class="n">metad_trajs</span><span class="o">=</span><span class="n">metad_trajs</span><span class="p">,</span>
            <span class="n">save_sep</span><span class="o">=</span><span class="n">save_sep</span><span class="p">,</span>
            <span class="n">all_to_xyz</span><span class="o">=</span><span class="n">all_to_xyz</span><span class="p">,</span>
            <span class="n">restart</span><span class="o">=</span><span class="n">restart</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">al_iter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_gaussian_heights</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_previous_parameters</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
            <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialise_inherited_bias</span><span class="p">(</span><span class="n">al_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_runs</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise files in order to load a bias generated during</span>
<span class="sd">        inherited-bias active learning</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bias_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;accumulated_bias/bias_after_iter_</span><span class="si">{</span><span class="n">al_iter</span><span class="si">}</span><span class="s1">.dat&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bias_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_runs</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">bias_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s1">&#39;Inherited bias generated after AL &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;iteration </span><span class="si">{</span><span class="n">al_iter</span><span class="si">}</span><span class="s1"> not found&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialise_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">n_runs</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise restart for metadynamics simulation by checking</span>
<span class="sd">        conditions and moving files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Make sure to use exactly the same width as &#39;</span>
                <span class="s1">&#39;in the previous simulation&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;plumed_files/metadynamics&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s1">&#39;Metadynamics folder not found, make &#39;</span>
                <span class="s1">&#39;sure to run metadynamics before &#39;</span>
                <span class="s1">&#39;trying to restart&#39;</span>
            <span class="p">)</span>

        <span class="n">metad_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;plumed_files/metadynamics&#39;</span><span class="p">)</span>
        <span class="n">traj_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;trajectories&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">:</span>
            <span class="n">colvar_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metad_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;colvar_</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_*.dat&#39;</span><span class="p">)</span>
            <span class="n">n_previous_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">colvar_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">n_previous_runs</span> <span class="o">!=</span> <span class="n">n_runs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s1">&#39;Restart is implemented only if the &#39;</span>
                    <span class="s1">&#39;number of runs matches the number &#39;</span>
                    <span class="s1">&#39;of runs in the previous simulation&#39;</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metad_path</span><span class="p">,</span> <span class="s1">&#39;fes_*.dat&#39;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;.dat&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
            <span class="n">src_folder</span><span class="o">=</span><span class="n">metad_path</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;.traj&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
            <span class="n">src_folder</span><span class="o">=</span><span class="n">traj_path</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_single_metad</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">,</span>
        <span class="n">al_iter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">restart</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;mlptrain.Trajectory&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiate a single metadynamics run&quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Running Metadynamics simulation &#39;</span> <span class="sa">f</span><span class="s1">&#39;number </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">al_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;copied_substrings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span>
            <span class="n">restart_files</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">cvs</span><span class="p">:</span>
                <span class="n">restart_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;colvar_</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">)</span>

            <span class="n">restart_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">)</span>
            <span class="n">restart_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;trajectory_</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.traj&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">restart_files</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;n_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">traj</span> <span class="o">=</span> <span class="n">run_mlp_md</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
            <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">restart_files</span><span class="o">=</span><span class="n">restart_files</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">traj</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_move_and_save_files</span><span class="p">(</span>
        <span class="n">metad_trajs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;mlptrain.Trajectory&#39;</span><span class="p">],</span>
        <span class="n">save_sep</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">all_to_xyz</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">restart</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save metadynamics trajectories, move them into trajectories folder</span>
<span class="sd">        and compute .xyz files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;.dat&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;plumed_files/metadynamics&#39;</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">restart</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;trajectory_\d+\.traj&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;trajectory_\d+_\w+\.traj&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;trajectories&#39;</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">restart</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;trajectories&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save_sep</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">metad_traj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metad_trajs</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">metad_traj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;metad_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.xyz&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">combined_traj</span> <span class="o">=</span> <span class="n">ConfigurationSet</span><span class="p">(</span><span class="n">allow_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">metad_traj</span> <span class="ow">in</span> <span class="n">metad_trajs</span><span class="p">:</span>
                <span class="n">combined_traj</span> <span class="o">+=</span> <span class="n">metad_traj</span>

            <span class="n">combined_traj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;combined_trajectory.xyz&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_to_xyz</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;trajectory_\d+_\w+\.traj&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">basename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">sim_time</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">ase_traj</span> <span class="o">=</span> <span class="n">ASETrajectory</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">ase_write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;metad_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sim_time</span><span class="si">}</span><span class="s1">.xyz&#39;</span><span class="p">,</span> <span class="n">ase_traj</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_previous_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set parameters in the _previous_run_parameters&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_run_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="n">configuration</span><span class="p">,</span>
            <span class="s1">&#39;mlp&#39;</span><span class="p">:</span> <span class="n">mlp</span><span class="p">,</span>
            <span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="n">temp</span><span class="p">,</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
            <span class="s1">&#39;interval&#39;</span><span class="p">:</span> <span class="n">interval</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">sim_time_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">sim_time_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_run_parameters</span><span class="p">[</span><span class="s1">&#39;sim_time_dict&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_time_dict</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Metadynamics.plot_gaussian_heights">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.plot_gaussian_heights">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_gaussian_heights</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">time_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;plumed_files/metadynamics&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the height of deposited gaussians as a function of time (using</span>
<span class="sd">        HILLS_{idx}.dat files).</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            energy_units: (str) Energy units to be used in plotting, available</span>
<span class="sd">                                units: &#39;eV&#39;, &#39;kcal mol-1&#39;, &#39;kJ mol-1&#39;</span>

<span class="sd">            time_units: (str) Time units to be used in plotting, available</span>
<span class="sd">                              units: &#39;fs&#39;, &#39;ps&#39;, &#39;ns&#39;</span>

<span class="sd">            path: (str) Directory where HILLS_{idx}.dat files are located</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s1">&#39;Directory with metadynamics files not &#39;</span>
                <span class="s1">&#39;found. Make sure to run metadynamics &#39;</span>
                <span class="s1">&#39;before using this method&#39;</span>
            <span class="p">)</span>

        <span class="n">initial_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_gaussian_heights_single</span><span class="p">(</span>
                <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span> <span class="n">time_units</span><span class="o">=</span><span class="n">time_units</span>
            <span class="p">)</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">initial_path</span><span class="p">)</span>
        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;gaussian_heights_\d+.pdf&#39;</span><span class="p">],</span>
            <span class="n">src_folder</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;gaussian_heights&#39;</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_gaussian_heights_single</span><span class="p">(</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ps&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the height of deposited gaussians as a function of time for a</span>
<span class="sd">        single metadynamics run.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            idx: (int) Index specifying metadynamics run number</span>

<span class="sd">            energy_units: (str) Energy units to be used in plotting, available</span>
<span class="sd">                                units: &#39;eV&#39;, &#39;kcal mol-1&#39;, &#39;kJ mol-1&#39;</span>

<span class="sd">            time_units: (str) Time units to be used in plotting, available</span>
<span class="sd">                              units: &#39;fs&#39;, &#39;ps&#39;, &#39;ns&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span>

        <span class="n">deposit_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">deposit_time</span> <span class="o">=</span> <span class="n">convert_ase_time</span><span class="p">(</span>
            <span class="n">time_array</span><span class="o">=</span><span class="n">deposit_time</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span>
        <span class="p">)</span>

        <span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">heights</span> <span class="o">=</span> <span class="n">convert_ase_energy</span><span class="p">(</span><span class="n">energy_array</span><span class="o">=</span><span class="n">heights</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">deposit_time</span><span class="p">,</span> <span class="n">heights</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time / </span><span class="si">{</span><span class="n">time_units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Gaussian height / </span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">energy_units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gaussian_heights_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Metadynamics.try_multiple_biasfactors">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.try_multiple_biasfactors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">try_multiple_biasfactors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">biasfactors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">pace</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">plotted_cvs</span><span class="p">:</span> <span class="n">Optional</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute multiple well-tempered metadynamics runs in parallel with a</span>
<span class="sd">        provided sequence of biasfactors and plot the resulting trajectories,</span>
<span class="sd">        useful for estimating the optimal biasfactor value.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            configuration: Configuration from which the simulation is started</span>

<span class="sd">            mlp: Machine learnt potential</span>

<span class="sd">            temp: (float) Temperature in K to initialise velocities and to run</span>
<span class="sd">                          NVT MD. Must be positive</span>

<span class="sd">            interval: (int) Interval between saving the geometry</span>

<span class="sd">            dt: (float) Time-step in fs</span>

<span class="sd">            biasfactors: Sequence of γ, describes how quickly gaussians shrink,</span>
<span class="sd">                         larger values make gaussians to be placed less</span>
<span class="sd">                         sensitive to the bias potential</span>

<span class="sd">            pace: (int) τ_G/dt, interval at which a new gaussian is placed</span>

<span class="sd">            height: (float) ω, initial height of placed gaussians (in eV)</span>

<span class="sd">            width: (List[float] | float | None) σ, standard deviation</span>
<span class="sd">                   (parameter describing the width) of placed gaussians,</span>
<span class="sd">                   if not supplied it is estimated automatically</span>

<span class="sd">            plotted_cvs: Sequence of one or two PlumedCV objects which are</span>
<span class="sd">                         going to be plotted, must be a subset for CVs used to</span>
<span class="sd">                         define the Metadynamics object</span>

<span class="sd">        -------------------</span>
<span class="sd">        Keyword Arguments:</span>

<span class="sd">            {fs, ps, ns}: Simulation time in some units</span>

<span class="sd">            {grid_min, grid_max, grid_bin}: Grid parameters: if defined, the</span>
<span class="sd">                                            deposited gaussians are dumped to</span>
<span class="sd">                                            a grid that is used to compute</span>
<span class="sd">                                            the biased forces</span>

<span class="sd">            constraints: (List) List of ASE constraints to use in the dynamics</span>
<span class="sd">                                e.g. [ase.constraints.Hookean(a1, a2, k, rt)]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trying </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">biasfactors</span><span class="p">)</span><span class="si">}</span><span class="s1"> different biasfactors&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">biasfactors</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Supplied biasfactors variable must be a sequence&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Temperature must be positive and non-zero for &#39;</span>
                <span class="s1">&#39;well-tempered metadynamics&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Height was not supplied, setting height to 0.5*k_B*T&#39;</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbt</span>

        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Width parameters were not supplied to the multiple &#39;</span>
                <span class="s1">&#39;biasfactor simulation, estimating widths &#39;</span>
                <span class="s1">&#39;automatically by performing an unbiased simulation&#39;</span>
                <span class="s1">&#39;for 10 ps&#39;</span>
            <span class="p">)</span>

            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_width</span><span class="p">(</span><span class="n">configurations</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">)</span>

        <span class="c1"># Dummy bias which stores CVs, useful for checking CVs input</span>
        <span class="k">if</span> <span class="n">plotted_cvs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cvs_holder</span> <span class="o">=</span> <span class="n">PlumedBias</span><span class="p">(</span><span class="n">plotted_cvs</span><span class="p">)</span>
            <span class="n">cvs_holder</span><span class="o">.</span><span class="n">_set_metad_cvs</span><span class="p">(</span><span class="n">plotted_cvs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cvs_holder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>

        <span class="k">if</span> <span class="n">cvs_holder</span><span class="o">.</span><span class="n">n_cvs</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Plotting using more than two CVs is &#39;</span> <span class="s1">&#39;not implemented&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">cv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">cvs_holder</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;At least one of the supplied CVs are not within &#39;</span>
                <span class="s1">&#39;the set of CVs used to define the Metadynamics &#39;</span>
                <span class="s1">&#39;object&#39;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">_set_metad_params</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">pace</span><span class="o">=</span><span class="n">pace</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">n_processes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">biasfactors</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Running Well-Tempered Metadynamics simulations &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">biasfactors</span><span class="p">)</span><span class="si">}</span><span class="s1"> different biasfactors, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_processes</span><span class="si">}</span><span class="s1"> simulation(s) run in parallel, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;1 walker per simulation&#39;</span>
        <span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">biasfactor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">biasfactors</span><span class="p">):</span>
                <span class="n">bias</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
                <span class="n">bias</span><span class="o">.</span><span class="n">biasfactor</span> <span class="o">=</span> <span class="n">biasfactor</span>

                <span class="n">kwargs_single</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">kwargs_single</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_try_single_biasfactor</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">configuration</span><span class="p">,</span>
                        <span class="n">mlp</span><span class="p">,</span>
                        <span class="n">temp</span><span class="p">,</span>
                        <span class="n">interval</span><span class="p">,</span>
                        <span class="n">dt</span><span class="p">,</span>
                        <span class="n">bias</span><span class="p">,</span>
                        <span class="n">cvs_holder</span><span class="o">.</span><span class="n">cvs</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">kwds</span><span class="o">=</span><span class="n">kwargs_single</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Simulations with multiple biasfactors done in &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> m&#39;</span>
        <span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;colvar_\w+_\d+\.dat&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;HILLS_\d+\.dat&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;plumed_files/multiple_biasfactors&#39;</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\w+_biasf\d+\.pdf&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;multiple_biasfactors&#39;</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_try_single_biasfactor</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="s1">&#39;mlptrain.Configuration&#39;</span><span class="p">,</span>
        <span class="n">mlp</span><span class="p">:</span> <span class="s1">&#39;mlptrain.potentials._base.MLPotential&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">,</span>
        <span class="n">plotted_cvs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a single well-tempered metadynamics run and plot the</span>
<span class="sd">        resulting trajectory</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_single_metad</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">,</span>
            <span class="n">mlp</span><span class="o">=</span><span class="n">mlp</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">kept_substrings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.dat&#39;</span><span class="p">],</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;colvar_</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.dat&#39;</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">plotted_cvs</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="n">plotted_cvs</span><span class="p">):</span>
            <span class="n">plot_cv_versus_time</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                <span class="n">cv_units</span><span class="o">=</span><span class="n">cv</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;biasf</span><span class="si">{</span><span class="n">bias</span><span class="o">.</span><span class="n">biasfactor</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotted_cvs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">plot_cv1_and_cv2</span><span class="p">(</span>
                <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">,</span>
                <span class="n">cvs_units</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="o">.</span><span class="n">units</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">plotted_cvs</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;biasf</span><span class="si">{</span><span class="n">bias</span><span class="o">.</span><span class="n">biasfactor</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Metadynamics.block_analysis">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.block_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">block_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">min_n_blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">min_blocksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">blocksize_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">bandwidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
        <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform block averaging analysis on the sliced trajectory of the most</span>
<span class="sd">        recent metadynamics run. Plot the block analysis and save mean FES</span>
<span class="sd">        grids with a range of block sizes, which, if the block analysis</span>
<span class="sd">        converged, can be used for plotting the FES error using plot_fes()</span>
<span class="sd">        method.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            start_time: (float) Start time of the sliced trajectory which is</span>
<span class="sd">                                going to be used for block averaging analysis</span>
<span class="sd">                                (in ps)</span>

<span class="sd">            idx: (int) Index specifying which metadynamics run (from n_runs)</span>
<span class="sd">                       to use for block analysis</span>

<span class="sd">            energy_units: (str) Energy units to be used in plotting, available</span>
<span class="sd">                                units: &#39;eV&#39;, &#39;kcal mol-1&#39;, &#39;kJ mol-1&#39;</span>

<span class="sd">            n_bins: (int) Number of bins to use when dumping histograms</span>

<span class="sd">            min_n_blocks: (int) Minimum number of blocks</span>

<span class="sd">            min_blocksize: (int) Minimum size of a block</span>

<span class="sd">            blocksize_interval: (int) Block size interval describing the</span>
<span class="sd">                                      difference in the number of frames per</span>
<span class="sd">                                      block for adjacent block sizes</span>

<span class="sd">            bandwidth: (float) Bandwidth parameter used in the histogram</span>
<span class="sd">                               estimations</span>

<span class="sd">            cvs_bounds: Specifies the range between which to compute the free</span>
<span class="sd">                        energy for each collective variable,</span>
<span class="sd">                        e.g. [(0.8, 1.5), (80, 120)]</span>

<span class="sd">            temp: (float) Temperature in K during the analysed simulation</span>

<span class="sd">            dt: (float) Time-step in fs during the analysed simulation</span>

<span class="sd">            interval: (int) Interval between saving the geometry during the</span>
<span class="sd">                            analysed simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="n">bias</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reweighting_params</span><span class="p">(</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span>
        <span class="p">)</span>
        <span class="n">start_frame_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">start_time</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">interval</span><span class="p">))</span>

        <span class="n">sliced_traj</span> <span class="o">=</span> <span class="n">ase_read</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;trajectories/trajectory_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.traj&#39;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">start_frame_index</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_ase_traj_as_xyz</span><span class="p">(</span><span class="n">sliced_traj</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
            <span class="n">src</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;plumed_files/metadynamics/HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">,</span>
            <span class="n">dst</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Writes plumed_setup.dat</span>
        <span class="n">plumed_setup</span><span class="p">(</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">load_metad_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">remove_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">write_plumed_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">min_max_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_min_max_params</span><span class="p">(</span>
            <span class="n">cvs_bounds</span><span class="o">=</span><span class="n">cvs_bounds</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;plumed_files/&#39;</span> <span class="s1">&#39;metadynamics&#39;</span>
        <span class="p">)</span>

        <span class="c1"># The number of frames PLUMED driver takes into account</span>
        <span class="c1"># n_used_frames = n_total_frames - 1</span>
        <span class="n">n_used_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sliced_traj</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">max_blocksize</span> <span class="o">=</span> <span class="n">n_used_frames</span> <span class="o">//</span> <span class="n">min_n_blocks</span>

        <span class="k">if</span> <span class="n">max_blocksize</span> <span class="o">&lt;</span> <span class="n">min_blocksize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The simulation is too short to perform &#39;</span> <span class="s1">&#39;block analysis&#39;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Performing block analysis in parallel using &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="si">}</span><span class="s1"> cores&#39;</span>
        <span class="p">)</span>

        <span class="n">grid_procs</span><span class="p">,</span> <span class="n">data_dict</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
        <span class="n">blocksizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="n">min_blocksize</span><span class="p">,</span> <span class="n">max_blocksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">blocksize_interval</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">blocksize</span> <span class="ow">in</span> <span class="n">blocksizes</span><span class="p">:</span>
                <span class="n">grid_proc</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_grids_for_blocksize</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">blocksize</span><span class="p">,</span>
                        <span class="n">temp</span><span class="p">,</span>
                        <span class="n">min_max_params</span><span class="p">,</span>
                        <span class="n">n_bins</span><span class="p">,</span>
                        <span class="n">bandwidth</span><span class="p">,</span>
                        <span class="n">energy_units</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">grid_procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_proc</span><span class="p">)</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">blocksize</span><span class="p">,</span> <span class="n">grid_proc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">blocksizes</span><span class="p">,</span> <span class="n">grid_procs</span><span class="p">):</span>
                <span class="n">cvs_grid</span><span class="p">,</span> <span class="n">fes_error</span> <span class="o">=</span> <span class="n">grid_proc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fes_error</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;CVs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cvs_grid</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s1">&#39;block_analysis.npz&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;plumed_setup.dat&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;traj.xyz&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_block_analysis</span><span class="p">(</span>
            <span class="n">blocksizes</span><span class="o">=</span><span class="n">blocksizes</span><span class="p">,</span>
            <span class="n">data_dict</span><span class="o">=</span><span class="n">data_dict</span><span class="p">,</span>
            <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Block analysis done in </span><span class="si">{</span><span class="p">(</span><span class="n">finish</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_reweighting_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read parameters required for reweighting from the previous</span>
<span class="sd">        metadynamics simulation. If previous parameters are not set, read</span>
<span class="sd">        parameters which are supplied to the method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Bias with dummy width and height values, and very large pace</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
        <span class="n">bias</span><span class="o">.</span><span class="n">_set_metad_params</span><span class="p">(</span>
            <span class="n">pace</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">)],</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">interval</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_previous_run_parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previous_run_parameters</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previous_run_parameters</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previous_run_parameters</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">_parameters</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Metadynamics object does not have all the &#39;</span>
                <span class="s1">&#39;required parameters to run block analysis. &#39;</span>
                <span class="s1">&#39;Please provide parameters from the previous &#39;</span>
                <span class="s1">&#39;metadynamics run&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">bias</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">interval</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_save_ase_traj_as_xyz</span><span class="p">(</span><span class="n">ase_traj</span><span class="p">:</span> <span class="s1">&#39;ase.io.trajectory.Trajectory&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save ASE trajectory as .xyz file&quot;&quot;&quot;</span>

        <span class="n">_mlt_configuration_set</span> <span class="o">=</span> <span class="n">ConfigurationSet</span><span class="p">(</span><span class="n">allow_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">ase_traj</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">ade</span><span class="o">.</span><span class="n">Atom</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">symbols</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()):</span>
                <span class="n">config</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">=</span> <span class="n">position</span>

            <span class="n">_mlt_configuration_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">_mlt_configuration_set</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;traj.xyz&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@work_in_tmp_dir</span><span class="p">(</span>
        <span class="n">copied_substrings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;traj.xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;plumed_setup.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;HILLS&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_grids_for_blocksize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blocksize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">min_max_params</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bandwidth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute CV and FES error grids over blocks for a given block size and</span>
<span class="sd">        return both grids&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_hist_files_by_reweighting</span><span class="p">(</span>
            <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">min_max_params</span><span class="o">=</span><span class="n">min_max_params</span><span class="p">,</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
            <span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">normal</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">cvs_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_histogram</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;hist.dat&#39;</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">compute_cvs</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">normal_sq</span> <span class="o">=</span> <span class="n">normal</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">normal</span> <span class="o">*</span> <span class="n">hist</span>
        <span class="n">average_sq</span> <span class="o">=</span> <span class="n">normal</span> <span class="o">*</span> <span class="n">hist</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">for</span> <span class="n">hist_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;analysis.*.hist.dat&#39;</span><span class="p">):</span>
            <span class="n">tnormal</span><span class="p">,</span> <span class="n">new_hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_histogram</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">hist_file</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span>
            <span class="p">)</span>
            <span class="n">normal</span> <span class="o">+=</span> <span class="n">tnormal</span>
            <span class="n">normal_sq</span> <span class="o">+=</span> <span class="n">tnormal</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">average</span> <span class="o">+=</span> <span class="n">tnormal</span> <span class="o">*</span> <span class="n">new_hist</span>
            <span class="n">average_sq</span> <span class="o">+=</span> <span class="n">tnormal</span> <span class="o">*</span> <span class="n">new_hist</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">average</span> <span class="o">/=</span> <span class="n">normal</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_sq</span> <span class="o">/</span> <span class="n">normal</span><span class="p">)</span> <span class="o">-</span> <span class="n">average</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">variance</span> <span class="o">*=</span> <span class="n">normal</span> <span class="o">/</span> <span class="p">(</span><span class="n">normal</span> <span class="o">-</span> <span class="p">(</span><span class="n">normal_sq</span> <span class="o">/</span> <span class="n">normal</span><span class="p">))</span>

        <span class="n">n_grids</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;analysis.*.hist.dat&#39;</span><span class="p">))</span>
        <span class="n">hist_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span> <span class="o">/</span> <span class="n">n_grids</span><span class="p">)</span>

        <span class="n">fes_error</span> <span class="o">=</span> <span class="n">ase_units</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">hist_error</span>
        <span class="n">fes_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
            <span class="n">fes_error</span><span class="p">,</span>
            <span class="n">average</span><span class="p">,</span>
            <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fes_error</span><span class="p">),</span>
            <span class="n">where</span><span class="o">=</span><span class="n">average</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fes_error</span> <span class="o">=</span> <span class="n">convert_ase_energy</span><span class="p">(</span>
            <span class="n">energy_array</span><span class="o">=</span><span class="n">fes_error</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">energy_units</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">cvs_grid</span><span class="p">,</span> <span class="n">fes_error</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_read_histogram</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">compute_cvs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the histogram file and return the normalisation together with</span>
<span class="sd">        the CVs and the histogram as numpy grids</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">grid_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">n_bins</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">)])</span>

        <span class="n">hist_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">hist_vector</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">grid_shape</span><span class="p">))</span>

        <span class="n">cvs_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">,</span> <span class="o">*</span><span class="n">grid_shape</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">compute_cvs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">):</span>
                <span class="n">cv_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

                <span class="n">cv_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cv_vector</span><span class="p">,</span> <span class="n">grid_shape</span><span class="p">)</span>
                <span class="n">cvs_grid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_grid</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#! SET normalisation&#39;</span><span class="p">):</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">normal</span><span class="p">),</span> <span class="n">hist</span><span class="p">,</span> <span class="n">cvs_grid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_hist_files_by_reweighting</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">blocksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">min_max_params</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bandwidth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate analysis.*.hist.dat + hist.dat files which are required</span>
<span class="sd">        for block analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PLUMED_MAXBACKUP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;10000&#39;</span>

        <span class="n">min_param_seq</span><span class="p">,</span> <span class="n">max_param_seq</span> <span class="o">=</span> <span class="n">min_max_params</span>
        <span class="n">bandwidth_seq</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">))</span>
        <span class="n">bin_param_seq</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">))</span>

        <span class="n">clear_setup</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;CLEAR=</span><span class="si">{</span><span class="n">blocksize</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">stride_setup</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;STRIDE=</span><span class="si">{</span><span class="n">blocksize</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">reweight_setup</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;as: REWEIGHT_BIAS &#39;</span> <span class="sa">f</span><span class="s1">&#39;TEMP=</span><span class="si">{</span><span class="n">temp</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="s1">&#39;ARG=metad.bias&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hist: HISTOGRAM &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;ARG=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cv_sequence</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;STRIDE=1 &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">clear_setup</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;GRID_MIN=</span><span class="si">{</span><span class="n">min_param_seq</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;GRID_MAX=</span><span class="si">{</span><span class="n">max_param_seq</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;GRID_BIN=</span><span class="si">{</span><span class="n">bin_param_seq</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;BANDWIDTH=</span><span class="si">{</span><span class="n">bandwidth_seq</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="s1">&#39;LOGWEIGHTS=as&#39;</span><span class="p">,</span>
            <span class="s1">&#39;DUMPGRID &#39;</span> <span class="s1">&#39;GRID=hist &#39;</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stride_setup</span><span class="si">}</span><span class="s1">&#39;</span> <span class="s1">&#39;FILE=hist.dat&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;plumed_setup.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;reweight.dat&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;reweight.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">reweight_setup</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">write_cv_files</span><span class="p">()</span>

        <span class="n">driver_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s1">&#39;plumed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;driver&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--ixyz&#39;</span><span class="p">,</span>
                <span class="s1">&#39;traj.xyz&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--plumed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reweight.dat&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--length-units&#39;</span><span class="p">,</span>
                <span class="s1">&#39;A&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">driver_process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_block_analysis</span><span class="p">(</span>
        <span class="n">blocksizes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the standard deviation versus block size&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">data_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;CVs&#39;</span><span class="p">)</span>
        <span class="n">mean_errors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">error_grid</span><span class="p">)</span> <span class="k">for</span> <span class="n">error_grid</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">blocksizes</span><span class="p">,</span> <span class="n">mean_errors</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Block size&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;$\left\langle\sigma_</span><span class="si">{G}</span><span class="s1">\right\rangle$ / &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">energy_units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;block_analysis.pdf&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">figname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">(</span><span class="n">figname</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Metadynamics.plot_fes">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.plot_fes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_fes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fes_npy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">blocksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the free energy surface with a confidence interval. If the .npy</span>
<span class="sd">        file is not supplied, the file is computed (if metadynamics has been</span>
<span class="sd">        run). If blocksize is supplied, the FES error is plotted using</span>
<span class="sd">        block_analysis.npz file with the given blocksize generated during</span>
<span class="sd">        block averaging analysis.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            energy_units: (str) Energy units to be used in computing the free</span>
<span class="sd">                                energy, available units: &#39;eV&#39;, &#39;kcal mol-1&#39;,</span>
<span class="sd">                                &#39;kJ mol-1&#39;. If fes_npy and/or blocksize options</span>
<span class="sd">                                are used, the units of fes_npy and/or blocksize</span>
<span class="sd">                                files must match energy units here</span>

<span class="sd">            confidence_level: (float) Specifies what confidence level to use</span>
<span class="sd">                                      in plots (probability for FES to lie in</span>
<span class="sd">                                      the plotted range)</span>

<span class="sd">            n_bins: (int) Number of bins to use in every dimension for fes file</span>
<span class="sd">                          generation from HILLS</span>

<span class="sd">            cvs_bounds: Specifies the range between which to compute the free</span>
<span class="sd">                        energy for each collective variable,</span>
<span class="sd">                        e.g. [(0.8, 1.5), (80, 120)]</span>

<span class="sd">            fes_npy: (str) File name of the .npy file used for plotting. FES</span>
<span class="sd">                           obtained through block analysis should be specified</span>
<span class="sd">                           using blocksize</span>

<span class="sd">            blocksize: (int) If block analysis has been performed, the integer</span>
<span class="sd">                             specifies which block size to use for plotting</span>
<span class="sd">                             the FES standard error</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">fes_npy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;fes_raw.npy&#39;</span><span class="p">):</span>
                <span class="n">fes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_fes</span><span class="p">(</span><span class="n">energy_units</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">cvs_bounds</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Using fes_raw.npy in the current directory for &#39;</span>
                    <span class="s1">&#39;plotting&#39;</span>
                <span class="p">)</span>

                <span class="n">fes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;fes_raw.npy&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fes_npy</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_1d_fes</span><span class="p">(</span>
                <span class="n">fes</span><span class="o">=</span><span class="n">fes</span><span class="p">,</span>
                <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span>
                <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">,</span>
                <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_2d_fes</span><span class="p">(</span>
                <span class="n">fes</span><span class="o">=</span><span class="n">fes</span><span class="p">,</span>
                <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span>
                <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">,</span>
                <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Plotting FES is available only for one &#39;</span>
                <span class="s1">&#39;and two collective variables&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Metadynamics.compute_fes">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.compute_fes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">via_reweighting</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00</span><span class="p">,</span>
        <span class="n">bandwidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a grid containing collective variable grids and free energy</span>
<span class="sd">        surface grids, which is saved in the current directory as .npy file.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            energy_units: (str) Energy units to be used in plotting, available</span>
<span class="sd">                                units: &#39;eV&#39;, &#39;kcal mol-1&#39;, &#39;kJ mol-1&#39;</span>

<span class="sd">            n_bins: (int) Number of bins to use in every dimension for fes file</span>
<span class="sd">                          generation from HILLS</span>

<span class="sd">            cvs_bounds: Specifies the range between which to compute the free</span>
<span class="sd">                        energy for each collective variable</span>
<span class="sd">                        e.g. [(0.8, 1.5), (80, 120)]</span>

<span class="sd">            via_reweighting: (bool) If true the free energy is computed using</span>
<span class="sd">                                    the reweighting scheme</span>

<span class="sd">            start_time: (float) Start time of the sliced trajectory which is</span>
<span class="sd">                                going to be used in reweighting (in ps)</span>

<span class="sd">            bandwidth: (float) Bandwidth parameter used in the histogram</span>
<span class="sd">                               estimations</span>

<span class="sd">            temp: (float) Temperature in K during the analysed simulation,</span>
<span class="sd">                          only needed when reweighting</span>

<span class="sd">            dt: (float) Time-step in fs during the analysed simulation, only</span>
<span class="sd">                        needed when reweighting</span>

<span class="sd">            interval: (int) Interval between saving the geometry during the</span>
<span class="sd">                            analysed simulation, only needed</span>
<span class="sd">                            when reweighting</span>

<span class="sd">        Returns:</span>

<span class="sd">            (np.ndarray): The total grid containing CVs and FESs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing and saving the free energy grid as fes_raw.npy&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">via_reweighting</span><span class="p">:</span>
            <span class="n">fes_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fes_via_reweighting</span><span class="p">(</span>
                <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span>
                <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
                <span class="n">cvs_bounds</span><span class="o">=</span><span class="n">cvs_bounds</span><span class="p">,</span>
                <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
                <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                <span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fes_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fes_via_hills</span><span class="p">(</span>
                <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">cvs_bounds</span><span class="o">=</span><span class="n">cvs_bounds</span>
            <span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;fes_raw.npy&#39;</span><span class="p">,</span> <span class="n">fes_raw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fes_raw</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_fes_via_reweighting</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">],</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bandwidth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the free energy surface grid by reweighting the biased</span>
<span class="sd">        distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bias</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reweighting_params</span><span class="p">(</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span>
        <span class="p">)</span>
        <span class="n">start_frame_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">start_time</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">interval</span><span class="p">))</span>

        <span class="n">min_max_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_min_max_params</span><span class="p">(</span>
            <span class="n">cvs_bounds</span><span class="o">=</span><span class="n">cvs_bounds</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;plumed_files/&#39;</span> <span class="s1">&#39;metadynamics&#39;</span>
        <span class="p">)</span>
        <span class="n">n_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;trajectories/trajectory_*.traj&#39;</span><span class="p">))</span>
        <span class="n">n_processes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">,</span> <span class="n">n_runs</span><span class="p">)</span>
        <span class="n">fes_processes</span><span class="p">,</span> <span class="n">fes_grids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_runs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">traj_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;trajectories/trajectory_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.traj&#39;</span>
                <span class="p">)</span>
                <span class="n">hills_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;plumed_files/metadynamics/HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span>
                <span class="p">)</span>

                <span class="n">proc</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_single_fes_via_reweighting</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">idx</span><span class="p">,</span>
                        <span class="n">traj_path</span><span class="p">,</span>
                        <span class="n">hills_path</span><span class="p">,</span>
                        <span class="n">start_frame_index</span><span class="p">,</span>
                        <span class="n">bias</span><span class="p">,</span>
                        <span class="n">temp</span><span class="p">,</span>
                        <span class="n">interval</span><span class="p">,</span>
                        <span class="n">min_max_params</span><span class="p">,</span>
                        <span class="n">n_bins</span><span class="p">,</span>
                        <span class="n">bandwidth</span><span class="p">,</span>
                        <span class="n">energy_units</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">fes_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">fes_processes</span><span class="p">:</span>
                <span class="n">cvs_grid</span><span class="p">,</span> <span class="n">fes_grid</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">fes_grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fes_grid</span><span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">fes_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">cvs_grid</span><span class="p">]</span> <span class="o">+</span> <span class="n">fes_grids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fes_raw</span>

    <span class="nd">@work_in_tmp_dir</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_single_fes_via_reweighting</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">traj_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">hills_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start_frame_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bias</span><span class="p">:</span> <span class="s1">&#39;mlptrain.PlumedBias&#39;</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">min_max_params</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">bandwidth</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute CVs and FES grids for a single run by reweighting&quot;&quot;&quot;</span>

        <span class="n">sliced_traj</span> <span class="o">=</span> <span class="n">ase_read</span><span class="p">(</span><span class="n">traj_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">start_frame_index</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_ase_traj_as_xyz</span><span class="p">(</span><span class="n">sliced_traj</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">hills_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">)</span>
        <span class="n">plumed_setup</span><span class="p">(</span>
            <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">load_metad_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">remove_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">write_plumed_setup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_hist_files_by_reweighting</span><span class="p">(</span>
            <span class="n">blocksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
            <span class="n">min_max_params</span><span class="o">=</span><span class="n">min_max_params</span><span class="p">,</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span>
            <span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">cvs_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_histogram</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;hist.dat&#39;</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">compute_cvs</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">fes_grid</span> <span class="o">=</span> <span class="o">-</span><span class="n">ase_units</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
        <span class="n">fes_grid</span> <span class="o">=</span> <span class="n">fes_grid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fes_grid</span><span class="p">)</span>
        <span class="n">fes_grid</span> <span class="o">=</span> <span class="n">convert_ase_energy</span><span class="p">(</span>
            <span class="n">energy_array</span><span class="o">=</span><span class="n">fes_grid</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">energy_units</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">cvs_grid</span><span class="p">,</span> <span class="n">fes_grid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_fes_via_hills</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the free energy surface grid using the deposited bias&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;plumed_files/metadynamics&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s1">&#39;Metadynamics directory not found. Make &#39;</span>
                <span class="s1">&#39;sure to run metadynamics before trying &#39;</span>
                <span class="s1">&#39;to compute the FES&#39;</span>
            <span class="p">)</span>

        <span class="n">fes_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;fes&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fes_files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_fes_files</span><span class="p">(</span><span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">cvs_bounds</span><span class="o">=</span><span class="n">cvs_bounds</span><span class="p">)</span>

        <span class="n">cv_grids</span><span class="p">,</span> <span class="n">fes_grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fes_files_to_grids</span><span class="p">(</span>
            <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span>
        <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../..&#39;</span><span class="p">)</span>

        <span class="n">fes_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">cv_grids</span><span class="p">,</span> <span class="n">fes_grids</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fes_raw</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_1d_fes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">blocksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot 1D mean free energy surface with a confidence interval&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting 1D FES&#39;</span><span class="p">)</span>

        <span class="n">cv_grid</span> <span class="o">=</span> <span class="n">fes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fes_grids</span> <span class="o">=</span> <span class="n">fes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">mean_fes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cv_grid</span><span class="p">,</span> <span class="n">mean_fes</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Free energy&#39;</span><span class="p">)</span>

        <span class="n">fes_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fes_error</span><span class="p">(</span>
            <span class="n">fes_grids</span><span class="o">=</span><span class="n">fes_grids</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fes_error</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                    <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;invalid value encountered in multiply&#39;</span>
                <span class="p">)</span>
                <span class="n">confidence_interval</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span>
                    <span class="n">confidence_level</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean_fes</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">fes_error</span>
                <span class="p">)</span>

            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">confidence_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">confidence_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">cv_grid</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="p">,</span>
                <span class="n">upper_bound</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Confidence interval&#39;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cv</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta G$ / &#39;</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">energy_units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;metad_free_energy.pdf&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">figname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">(</span><span class="n">figname</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_2d_fes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">blocksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot 2D mean free energy surface with a confidence interval&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting 2D FES&#39;</span><span class="p">)</span>

        <span class="n">cv1_grid</span> <span class="o">=</span> <span class="n">fes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cv2_grid</span> <span class="o">=</span> <span class="n">fes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fes_grids</span> <span class="o">=</span> <span class="n">fes</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax_mean</span><span class="p">,</span> <span class="n">ax_std_error</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">jet_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">jet_cmap_matrix</span> <span class="o">=</span> <span class="n">jet_cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="n">jet_cmap_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">mod_jet_cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">jet_cmap_matrix</span><span class="p">)</span>

        <span class="n">mean_fes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mean_contourf</span> <span class="o">=</span> <span class="n">ax_mean</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
            <span class="n">cv1_grid</span><span class="p">,</span> <span class="n">cv2_grid</span><span class="p">,</span> <span class="n">mean_fes</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">mod_jet_cmap</span>
        <span class="p">)</span>
        <span class="n">ax_mean</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
            <span class="n">cv1_grid</span><span class="p">,</span> <span class="n">cv2_grid</span><span class="p">,</span> <span class="n">mean_fes</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
        <span class="p">)</span>

        <span class="n">mean_cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mean_contourf</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_mean</span><span class="p">)</span>
        <span class="n">mean_cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\Delta G$ / &#39;</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">energy_units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="n">fes_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_fes_error</span><span class="p">(</span>
            <span class="n">fes_grids</span><span class="o">=</span><span class="n">fes_grids</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="n">blocksize</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;invalid value encountered in multiply&#39;</span>
            <span class="p">)</span>
            <span class="n">confidence_interval</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span>
                <span class="n">confidence_level</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mean_fes</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">fes_error</span>
            <span class="p">)</span>

        <span class="n">interval_range</span> <span class="o">=</span> <span class="n">confidence_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">confidence_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">std_error_contourf</span> <span class="o">=</span> <span class="n">ax_std_error</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
            <span class="n">cv1_grid</span><span class="p">,</span> <span class="n">cv2_grid</span><span class="p">,</span> <span class="n">interval_range</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span>
        <span class="p">)</span>
        <span class="n">ax_std_error</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
            <span class="n">cv1_grid</span><span class="p">,</span> <span class="n">cv2_grid</span><span class="p">,</span> <span class="n">mean_fes</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>
        <span class="p">)</span>

        <span class="n">std_error_cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">std_error_contourf</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_std_error</span><span class="p">)</span>
        <span class="n">std_error_cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Confidence interval / &#39;</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">energy_units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="n">cv1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cv2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax_mean</span><span class="p">,</span> <span class="n">ax_std_error</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cv1</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">cv1</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">cv2</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cv2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mean_contourf</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">std_error_contourf</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">figname</span> <span class="o">=</span> <span class="s1">&#39;metad_free_energy.pdf&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">figname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">figname</span><span class="p">,</span> <span class="n">unique_name</span><span class="p">(</span><span class="n">figname</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figname</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_fes_error</span><span class="p">(</span>
        <span class="n">fes_grids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute standard error of the free energy to use in plotting&quot;&quot;&quot;</span>

        <span class="n">n_surfaces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fes_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;block_analysis.npz&#39;</span><span class="p">)[</span><span class="nb">str</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)]</span>
                <span class="n">fes_error</span> <span class="o">=</span> <span class="n">fes_error</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="s1">&#39;Block averaging analysis with block &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;size </span><span class="si">{</span><span class="n">blocksize</span><span class="si">}</span><span class="s1"> was not found. &#39;</span>
                    <span class="s1">&#39;Make sure to run block analysis &#39;</span>
                    <span class="s1">&#39;before using this option and use an &#39;</span>
                    <span class="s1">&#39;appropriate block size&#39;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">n_surfaces</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fes_error</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_surfaces</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
                <span class="n">fes_grids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fes_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fes_error</span>

<div class="viewcode-block" id="Metadynamics.plot_fes_convergence">
<a class="viewcode-back" href="../../../references/mlptrain.sampling.metadynamics.html#mlptrain.Metadynamics.plot_fes_convergence">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_fes_convergence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_surfaces</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">time_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ps&#39;</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;kcal mol-1&#39;</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute multiple fes.dat files from a HILLS_idx.dat file by summing</span>
<span class="sd">        the deposited gaussians using a stride. Use the computed files to plot</span>
<span class="sd">        multiple FESs as a function of simulation time.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            stride: (int) Interval that specifies the number of new gaussians</span>
<span class="sd">                          that is put into subsequent fes_idx_*.dat file</span>

<span class="sd">            n_surfaces: (int) Number of surfaces to be plotted (counting from</span>
<span class="sd">                              the last computed surface), must not exceed the</span>
<span class="sd">                              number of computed surfaces</span>

<span class="sd">            time_units: (str) Time units to be used in plotting, available</span>
<span class="sd">                              units: &#39;fs&#39;, &#39;ps&#39;, &#39;ns&#39;</span>

<span class="sd">            energy_units: (str) Energy units to be used in plotting, available</span>
<span class="sd">                                units: &#39;eV&#39;, &#39;kcal mol-1&#39;, &#39;kJ mol-1&#39;</span>

<span class="sd">            n_bins: (int) Number of bins to use in every dimension for fes file</span>
<span class="sd">                          generation from HILLS</span>

<span class="sd">            cvs_bounds: Specifies the range between which to compute the free</span>
<span class="sd">                        energy for each collective variable,</span>
<span class="sd">                        e.g. [(0.8, 1.5), (80, 120)]</span>

<span class="sd">            idx: (int) Integer which specifies which metadynamics run to use</span>
<span class="sd">                       for plotting the FES convergence</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting FES convergence&#39;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;plumed_files/metadynamics&#39;</span><span class="p">)</span>

        <span class="c1"># List of times when a new gaussian is deposited</span>
        <span class="n">deposit_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">fes_time</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">deposit_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stride</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">deposit_time</span><span class="p">),</span> <span class="n">stride</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># sum_hills generates surfaces with the stride,</span>
        <span class="c1"># but it also always computes the final FES</span>
        <span class="n">remove_duplicate</span> <span class="o">=</span> <span class="n">fes_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">deposit_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fes_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deposit_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">fes_time</span> <span class="o">=</span> <span class="n">convert_ase_time</span><span class="p">(</span>
            <span class="n">time_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fes_time</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span>
        <span class="p">)</span>
        <span class="n">fes_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">fes_time</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_fes_files</span><span class="p">(</span>
            <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">cvs_bounds</span><span class="o">=</span><span class="n">cvs_bounds</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span>
        <span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">rf</span><span class="s1">&#39;fes_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_\d+\.dat&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;../fes_convergence&#39;</span><span class="p">,</span>
            <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../fes_convergence&#39;</span><span class="p">)</span>

        <span class="c1"># Remove the final FES if it has already been computed with the stride</span>
        <span class="c1"># (file enumeration using stride starts from zero)</span>
        <span class="k">if</span> <span class="n">remove_duplicate</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fes_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fes_time</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">)</span>
            <span class="n">fes_time</span> <span class="o">=</span> <span class="n">fes_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">cv_grids</span><span class="p">,</span> <span class="n">fes_grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fes_files_to_grids</span><span class="p">(</span>
            <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_bins</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_surface_difference</span><span class="p">(</span>
            <span class="n">fes_grids</span><span class="o">=</span><span class="n">fes_grids</span><span class="p">,</span>
            <span class="n">fes_time</span><span class="o">=</span><span class="n">fes_time</span><span class="p">,</span>
            <span class="n">time_units</span><span class="o">=</span><span class="n">time_units</span><span class="p">,</span>
            <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_multiple_1d_fes_surfaces</span><span class="p">(</span>
                <span class="n">cv_grids</span><span class="o">=</span><span class="n">cv_grids</span><span class="p">,</span>
                <span class="n">fes_grids</span><span class="o">=</span><span class="n">fes_grids</span><span class="p">,</span>
                <span class="n">fes_time</span><span class="o">=</span><span class="n">fes_time</span><span class="p">,</span>
                <span class="n">n_surfaces</span><span class="o">=</span><span class="n">n_surfaces</span><span class="p">,</span>
                <span class="n">time_units</span><span class="o">=</span><span class="n">time_units</span><span class="p">,</span>
                <span class="n">energy_units</span><span class="o">=</span><span class="n">energy_units</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../..&#39;</span><span class="p">)</span>

        <span class="n">move_files</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;fes_convergence.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;fes_convergence_diff.pdf&#39;</span><span class="p">],</span>
            <span class="n">dst_folder</span><span class="o">=</span><span class="s1">&#39;fes_convergence&#39;</span><span class="p">,</span>
            <span class="n">src_folder</span><span class="o">=</span><span class="s1">&#39;plumed_files/fes_convergence&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_surface_difference</span><span class="p">(</span>
        <span class="n">fes_grids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">fes_time</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">time_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the root mean square difference between free energy surfaces</span>
<span class="sd">        as a function of time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">fes_diff_grids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rms_diffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">grid</span> <span class="o">*</span> <span class="n">grid</span><span class="p">))</span> <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">fes_diff_grids</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fes_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">rms_diffs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time / </span><span class="si">{</span><span class="n">time_units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;$\left\langle\Delta\Delta G^</span><span class="si">{2}</span><span class="s1"> &#39;</span>
            <span class="sa">r</span><span class="s1">&#39;\right\rangle^{\frac</span><span class="si">{1}{2}</span><span class="s1">}$ / &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">energy_units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;fes_convergence_diff.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_multiple_1d_fes_surfaces</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cv_grids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">fes_grids</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">fes_time</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">n_surfaces</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">time_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple 1D free energy surfaces as a function of simulation time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

        <span class="n">plotted_cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">n_surfaces</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The number of surfaces requested to plot is &#39;</span>
                <span class="s1">&#39;larger than the number of computed surfaces&#39;</span>
            <span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_surfaces</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">cv_grids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fes_grids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fes_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">time_units</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">plotted_cv</span><span class="o">.</span><span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plotted_cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">plotted_cv</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plotted_cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta G$ / &#39;</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">convert_exponents</span><span class="p">(</span><span class="n">energy_units</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;fes_convergence.pdf&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_fes_files</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate fes.dat files from a HILLS.dat file.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            n_bins: (int) Number of bins to use in every dimension for fes file</span>
<span class="sd">                          generation from HILLS</span>

<span class="sd">            cvs_bounds: Specifies the range between which to compute the free</span>
<span class="sd">                        energy for each collective variable</span>

<span class="sd">            stride: (int) Interval that specifies the number of new gaussians</span>
<span class="sd">                          that is put into subsequent fes_idx_*.dat file</span>

<span class="sd">            idx: (int) Integer which specifies which metadynamics run to use</span>
<span class="sd">                       for plotting the FES convergence</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HILLS&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s1">&#39;No HILLS.dat files were found in &#39;</span>
                <span class="s1">&#39;plumed_files, make sure to run &#39;</span>
                <span class="s1">&#39;metadynamics before computing the FES&#39;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating fes.dat files from HILLS.dat files&#39;</span><span class="p">)</span>

        <span class="n">bin_param_seq</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">))</span>
        <span class="n">min_param_seq</span><span class="p">,</span> <span class="n">max_param_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_min_max_params</span><span class="p">(</span><span class="n">cvs_bounds</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">idx</span>

        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HILLS_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.dat&#39;</span><span class="p">):</span>
            <span class="c1"># HILLS_*.dat -&gt; *</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">stride</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fes_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;fes_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">.dat&#39;</span>
                <span class="n">stride_setup</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fes_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;fes_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">_&#39;</span>
                <span class="n">stride_setup</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--stride&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

            <span class="n">compute_fes</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s1">&#39;plumed&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;sum_hills&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;--hills&#39;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="p">,</span>
                    <span class="s1">&#39;--outfile&#39;</span><span class="p">,</span>
                    <span class="n">fes_filename</span><span class="p">,</span>
                    <span class="s1">&#39;--bin&#39;</span><span class="p">,</span>
                    <span class="n">bin_param_seq</span><span class="p">,</span>
                    <span class="s1">&#39;--min&#39;</span><span class="p">,</span>
                    <span class="n">min_param_seq</span><span class="p">,</span>
                    <span class="s1">&#39;--max&#39;</span><span class="p">,</span>
                    <span class="n">max_param_seq</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">stride_setup</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">compute_fes</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fes_files_to_grids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">energy_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">relative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use fes.dat files in a current directory to compute a grid containing</span>
<span class="sd">        collective variables and a grid containing free energy surfaces.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            energy_units: (str) Energy units to be used in plotting, available</span>
<span class="sd">                                units: &#39;eV&#39;, &#39;kcal mol-1&#39;, &#39;kJ mol-1&#39;</span>

<span class="sd">            n_bins: (int) Number of bins to used in every dimension when fes</span>
<span class="sd">                          files were generated</span>

<span class="sd">            relative: (bool) If True the energies of the free energy surfaces</span>
<span class="sd">                             are shifted such that the global minima are at</span>
<span class="sd">                             zero</span>

<span class="sd">        Returns:</span>

<span class="sd">            (Tuple): Two grids containing CVs and FESs in supplied energy units</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">grid_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">n_bins</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">)])</span>

        <span class="c1"># Sort names to retain ordering in the final grid</span>
        <span class="n">unordered_fes_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;fes&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>

        <span class="c1"># &#39;fes_1_12.dat&#39; -&gt; int(112)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_get_combined_index</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">name_without_extension</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">name_without_extension</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">combined_index</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>

            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_index</span><span class="p">)</span>

        <span class="n">fes_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unordered_fes_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">_get_combined_index</span><span class="p">)</span>

        <span class="c1"># Compute CV grids</span>
        <span class="n">cv_grids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fes_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">):</span>
                <span class="n">cv_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>

                <span class="n">cv_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cv_vector</span><span class="p">,</span> <span class="n">grid_shape</span><span class="p">)</span>
                <span class="n">cv_grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv_grid</span><span class="p">)</span>

            <span class="c1"># All fes files would generate same grids -&gt; can break</span>
            <span class="k">break</span>

        <span class="c1"># Compute fes grids</span>
        <span class="n">fes_grids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fes_files</span><span class="p">:</span>
            <span class="n">fes_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">)</span>

            <span class="n">fes_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fes_vector</span><span class="p">,</span> <span class="n">grid_shape</span><span class="p">)</span>
            <span class="n">fes_grid</span> <span class="o">=</span> <span class="n">convert_ase_energy</span><span class="p">(</span>
                <span class="n">energy_array</span><span class="o">=</span><span class="n">fes_grid</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">energy_units</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
                <span class="n">fes_grid</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fes_grid</span><span class="p">)</span>

            <span class="n">fes_grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fes_grid</span><span class="p">)</span>

        <span class="n">total_cv_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">cv_grids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">total_fes_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">fes_grids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total_cv_grid</span><span class="p">,</span> <span class="n">total_fes_grid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_min_max_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute min and max parameters for generating fes.dat files from</span>
<span class="sd">        HILLS.dat files.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            cvs_bounds: Specifies the range between which to compute the free</span>
<span class="sd">                        energy for each collective variable</span>

<span class="sd">            path: (str) Relative path where HILLS.dat files are located</span>

<span class="sd">        Returns:</span>

<span class="sd">            (Tuple): Two sequences of min and max parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cvs_bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;CVs bounds were not supplied, generating min and max &#39;</span>
                <span class="s1">&#39;parameters automatically&#39;</span>
            <span class="p">)</span>

            <span class="n">initial_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">initial_path</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="n">min_params</span><span class="p">,</span> <span class="n">max_params</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">metad_cvs</span><span class="p">:</span>
                <span class="n">min_values</span><span class="p">,</span> <span class="n">max_values</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;colvar_</span><span class="si">{</span><span class="n">cv</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_*.dat&#39;</span><span class="p">):</span>
                    <span class="n">cv_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">min_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cv_values</span><span class="p">))</span>
                    <span class="n">max_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cv_values</span><span class="p">))</span>

                <span class="n">total_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_values</span><span class="p">)</span>
                <span class="n">total_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_values</span><span class="p">)</span>

                <span class="n">extension</span> <span class="o">=</span> <span class="mf">0.309</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_max</span> <span class="o">-</span> <span class="n">total_min</span><span class="p">)</span>

                <span class="n">min_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">total_min</span> <span class="o">-</span> <span class="n">extension</span><span class="p">))</span>
                <span class="n">max_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">total_max</span> <span class="o">+</span> <span class="n">extension</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">initial_path</span><span class="p">)</span>

            <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">min_params</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">max_params</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cvs_bounds_checked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_cv_bounds</span><span class="p">(</span><span class="n">cvs_bounds</span><span class="p">)</span>

            <span class="n">min_params</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">cv_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">cv_bounds</span> <span class="ow">in</span> <span class="n">cvs_bounds_checked</span>
            <span class="p">]</span>
            <span class="n">max_params</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">cv_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">cv_bounds</span> <span class="ow">in</span> <span class="n">cvs_bounds_checked</span>
            <span class="p">]</span>

            <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">min_params</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">max_params</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_cv_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cvs_bounds</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the validity of the supplied CVs bounds and returns the bounds</span>
<span class="sd">        in a universal format.</span>

<span class="sd">        -----------------------------------------------------------------------</span>
<span class="sd">        Arguments:</span>

<span class="sd">            cvs_bounds: Specifies the range between which to compute the free</span>
<span class="sd">                        energy for each collective variable</span>

<span class="sd">        Returns:</span>

<span class="sd">            (Sequence): CVs bounds in a universal format</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cvs_bounds</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cvs_bounds</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cvs_bounds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s1">&#39;CVs bounds cannot be an empty list or &#39;</span> <span class="s1">&#39;an empty tuple&#39;</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">cv_bounds</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cv_bounds</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cv_bounds</span> <span class="ow">in</span> <span class="n">cvs_bounds</span>
            <span class="p">):</span>
                <span class="n">_cvs_bounds</span> <span class="o">=</span> <span class="n">cvs_bounds</span>

            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">cv_bound</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cv_bound</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cv_bound</span> <span class="ow">in</span> <span class="n">cvs_bounds</span>
            <span class="p">):</span>
                <span class="n">_cvs_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">cvs_bounds</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;CVs bounds are in incorrect format&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;CVs bounds are in incorrect format&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cvs_bounds</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cvs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The number of supplied CVs bounds is not equal &#39;</span>
                <span class="s1">&#39;to the number of CVs used in metadynamics&#39;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">_cvs_bounds</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Duarte group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>